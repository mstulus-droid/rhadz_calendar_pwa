<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>Rhadz Calendar</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    screens: {
                        'lg': '1024px',
                    },
                    colors: {
                        primary: 'var(--accent-color)',
                    }
                }
            }
        }
    </script>
    <style>
        :root {
            /* Default Theme (Royal) */
            --bg-color: #cbd5e1;
            --card-bg: #f8fafc;
            --premium-gradient: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
            --accent-color: #3b82f6;
            --text-primary: #1e293b;
            --gold-gradient: linear-gradient(135deg, #d97706 0%, #fbbf24 100%);
            --romance-gradient: linear-gradient(135deg, #be185d 0%, #ec4899 100%);
        }

        /* Theme Variations Classes */
        .theme-emerald {
            --bg-color: #d1fae5;
            --premium-gradient: linear-gradient(135deg, #064e3b 0%, #059669 100%);
            --accent-color: #10b981;
        }

        .theme-amethyst {
            --bg-color: #f3e8ff;
            --premium-gradient: linear-gradient(135deg, #4c1d95 0%, #7c3aed 100%);
            --accent-color: #8b5cf6;
        }

        .theme-crimson {
            --bg-color: #ffe4e6;
            --premium-gradient: linear-gradient(135deg, #881337 0%, #e11d48 100%);
            --accent-color: #f43f5e;
        }

        /* --- TAMBAHAN TEMA BARU --- */
        .theme-midnight {
            --bg-color: #cbd5e1;
            --premium-gradient: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            --accent-color: #475569;
        }

        .theme-ocean {
            --bg-color: #ecfeff;
            --premium-gradient: linear-gradient(135deg, #155e75 0%, #083344 100%);
            --accent-color: #06b6d4;
        }

        .theme-sunset {
            --bg-color: #ffedd5;
            --premium-gradient: linear-gradient(135deg, #9a3412 0%, #7c2d12 100%);
            --accent-color: #ea580c;
        }

        .theme-coffee {
            --bg-color: #f5ebe0;
            --premium-gradient: linear-gradient(135deg, #78350f 0%, #451a03 100%);
            --accent-color: #a0522d;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.5s ease;
        }

        .app-container {
            width: 100%;
            height: 100%;
            background: #f8fafc;
            display: flex;
            flex-direction: column;
            position: relative;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        @media (max-width: 1023px) {
            .app-container {
                max-width: 448px;
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.2);
            }

            .desktop-sidebar,
            .desktop-header-controls {
                display: none;
            }

            body {
                align-items: flex-start;
            }

            .main-content {
                flex: 1;
                display: flex !important;
                flex-direction: column;
                overflow: hidden !important;
                padding: 0 !important;
                position: relative;
                min-height: 0;
            }

            .calendar-section-mobile {
                flex-shrink: 0;
                /* Padding dikurangi jadi 4px (0.25rem) biar muat di HP kecil */
                padding: 1rem 0.25rem 0.5rem 0.25rem;
                background: #f8fafc;
                z-index: 10;
                box-shadow: 0 4px 10px -5px rgba(0, 0, 0, 0.1);
                transition: margin-top 0.3s ease;

                /* --- TAMBAHAN PENTING --- */
                width: 100%;
                /* Lebar penuh */
                display: flex;
                /* Aktifkan mode flex */
                justify-content: center;
                /* Paksa konten ke TENGAH */
                box-sizing: border-box;
                /* Hitung padding sebagai bagian dari lebar */
            }

            .info-section-mobile {
                flex: 1;
                overflow-y: auto;
                padding: 1rem;
                background: #f1f5f9;
                scroll-behavior: smooth;
                padding-bottom: 7rem;
            }

            .footer-rhadzor {
                background: var(--premium-gradient) !important;
                color: white !important;
                border-top: none !important;
                padding: 0.75rem 1.5rem;
                box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
                justify-content: space-between !important;
            }
        }

        @media (min-width: 1024px) {
            body {
                align-items: center;
                background-image: url('https://images.unsplash.com/photo-1497864149936-d466327778cd?q=80&w=2070&auto=format&fit=crop');
                background-size: cover;
                background-position: center;
                backdrop-filter: blur(8px);
            }

            .app-container {
                max-width: 1400px;
                height: 90vh;
                max-height: 900px;
                flex-direction: row;
                border-radius: 24px;
                overflow: hidden;
                box-shadow: 0 50px 100px -20px rgba(0, 0, 0, 0.5);
                background: rgba(255, 255, 255, 0.95);
            }

            .header-rhadzor,
            .footer-rhadzor {
                display: none !important;
            }

            .desktop-sidebar {
                display: flex !important;
            }

            .desktop-right-panel {
                display: flex !important;
            }

            .main-content {
                padding: 1.5rem 2rem !important;
                overflow: hidden;
                background: white;
                display: block;
            }

            .calendar-section-mobile {
                padding: 0;
                box-shadow: none;
                background: transparent;
                height: 100%;
                display: flex;
                flex-direction: column;
            }

            .info-section-mobile {
                display: none;
            }
        }

        .header-rhadzor {
            background: var(--premium-gradient);
            padding: 0 1rem;
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 50;
            height: 70px;
            flex-shrink: 0;
            position: relative;
        }

        .header-left,
        .header-right {
            width: 44px;
            display: flex;
            justify-content: center;
        }

        .header-center {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .nav-arrow {
            padding: 0.5rem;
            cursor: pointer;
            opacity: 0.6;
            transition: 0.2s;
        }

        .nav-arrow:hover {
            opacity: 1;
        }

        .hijri-label {
            font-size: 0.6rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            opacity: 0.6;
            color: #cbd5e1;
        }

        .month-year-title {
            display: flex;
            gap: 0.5rem;
            font-size: 1.15rem;
            font-weight: 800;
            letter-spacing: -0.025em;
        }

        .desktop-sidebar {
            width: 280px;
            background: var(--premium-gradient);
            color: white;
            display: none;
            flex-direction: column;
            padding: 2rem;
            justify-content: space-between;
            box-shadow: 4px 0 24px rgba(0, 0, 0, 0.1);
            z-index: 30;
        }

        .desktop-right-panel {
            width: 320px;
            background: #f1f5f9;
            display: none;
            flex-direction: column;
            padding: 1.5rem;
            border-left: 1px solid #e2e8f0;
            overflow-y: auto;
        }

        .main-content {
            flex: 1;
            scrollbar-width: none;
        }

        .main-content::-webkit-scrollbar {
            display: none;
        }

        .calendar-card {
            background: var(--card-bg);
            border-radius: 24px;
            padding: 1rem 0.5rem;
            /* Padding dalam dikurangi */
            position: relative;
            touch-action: pan-y pinch-zoom;
            box-shadow: 8px 8px 16px rgba(0, 0, 0, 0.05), -8px -8px 16px rgba(255, 255, 255, 0.8);
            perspective: 1200px;

            /* --- TAMBAHAN PENTING --- */
            width: 100%;
            /* Mengikuti lebar bapaknya */
            max-width: 100%;
            /* Jangan pernah melebihi layar */
            box-sizing: border-box;
            /* Padding dihitung di dalam lebar */
        }

        @media (min-width: 1024px) {
            .calendar-card {
                box-shadow: none;
                background: transparent;
                padding: 0;
                flex: 1;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }

            .calendar-grid-container {
                height: 100%;
            }

            .calendar-grid {
                height: 100%;
                grid-template-rows: 30px repeat(6, 1fr);
            }
        }

        .calendar-grid-container {
            width: 100%;
            transform-style: preserve-3d;
            backface-visibility: hidden;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            /* GANTI JADI 1px: Biar muat banyak */
            width: 100%;
        }

        @media (min-width: 1024px) {
            .calendar-grid {
                gap: 8px;
            }
        }

        .day-label {
            text-align: center;
            font-size: 0.7rem;
            font-weight: 800;
            color: #64748b;
            padding-bottom: 0.75rem;
            text-transform: uppercase;
        }

        @media (min-width: 1024px) {
            .day-label {
                padding-bottom: 0;
                display: flex;
                align-items: center;
                justify-content: center;
            }
        }

        .day-cell {
            aspect-ratio: 1/1.1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 14px;
            font-size: 1.35rem;
            /* DIBESARKAN (Tadinya 1.1rem) */
            font-weight: 700;
            /* DITEBALKAN */
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
            color: #1e293b;
            border: 1px solid transparent;
            padding-top: 4px;
            /* Sedikit padding atas biar seimbang */
        }

        /* Tambahan agar angka tidak terlalu renggang dengan Pasaran/Hijriah */
        .date-wrapper {
            line-height: 0.9;
            margin-bottom: 2px;
        }

        .day-cell.other-month {
            opacity: 0.25;
            transform: scale(0.9);
            font-size: 0.9rem;
            pointer-events: none;
        }

        @media (min-width: 1024px) {
            .day-cell {
                aspect-ratio: auto;
                min-height: 40px;
                border-radius: 12px;
                background: #f8fafc;
                align-items: center;
                justify-content: center;
                padding: 2px;
            }

            .day-cell .date-wrapper {
                font-size: 1.4rem;
                font-weight: 700;
                margin-bottom: 1px;
            }

            .day-cell:hover:not(.other-month) {
                background: #e2e8f0;
                transform: translateY(-2px);
            }

            .hijri-text {
                top: 4px;
                right: 6px;
                font-size: 0.6rem !important;
            }

            .pasaran-text {
                margin-top: 0;
                align-self: center;
                font-size: 0.6rem !important;
                opacity: 0.7;
            }
        }

        .day-cell.today {
            background: var(--premium-gradient);
            color: white !important;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            transform: scale(1.02);
            z-index: 2;
            border: none;
        }

        @keyframes attractive-pulse {
            0% {
                box-shadow: 0 0 0 0px rgba(59, 130, 246, 0.4);
                transform: scale(1.02);
            }

            50% {
                box-shadow: 0 0 0 15px rgba(59, 130, 246, 0);
                transform: scale(1.1);
            }

            100% {
                box-shadow: 0 0 0 0px rgba(59, 130, 246, 0);
                transform: scale(1.02);
            }
        }

        .today-jump-animation {
            animation: attractive-pulse 0.8s ease-out 2;
        }

        .day-cell.birthday {
            background: var(--gold-gradient);
            color: white !important;
            box-shadow: 0 4px 12px rgba(217, 119, 6, 0.4);
            border: 2px solid white;
            z-index: 3;
        }

        .day-cell.anniversary {
            background: var(--romance-gradient);
            color: white !important;
            box-shadow: 0 4px 12px rgba(190, 24, 93, 0.4);
            border: 2px solid white;
            z-index: 3;
        }

        .day-cell.sunday,
        .day-cell.holiday {
            color: #ef4444;
        }

        .day-cell.friday {
            color: #059669;
        }

        .date-wrapper {
            position: relative;
            line-height: 1;
        }

        .cuti-dot,
        .obs-dot {
            position: absolute;
            width: 5px;
            height: 5px;
            border-radius: 50%;
            z-index: 10;
        }

        .cuti-dot {
            bottom: 2px;
            right: -6px;
            background-color: #ef4444;
        }

        .obs-dot {
            bottom: 2px;
            left: -6px;
            background-color: #3b82f6;
        }

        /* --- UPDATE CSS: GARIS NOTE DI BAWAH ANGKA --- */
        .note-indicator {
            position: absolute;
            bottom: -4px;
            /* Jarak rapat di bawah angka */
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            /* Lebar garis */
            height: 3px;
            /* Ketebalan garis */
            background-color: var(--accent-color);
            border-radius: 99px;
            z-index: 10;
            pointer-events: none;
            /* Agar tidak mengganggu klik */
        }

        /* Warna garis saat hari ini (Today) agar kontras dengan background gelap/gradient */
        .day-cell.today .note-indicator {
            background-color: rgba(255, 255, 255, 0.8);
        }

        @media (min-width: 1024px) {
            .cuti-dot {
                bottom: 3px;
                right: -6px;
                width: 5px;
                height: 5px;
            }

            .obs-dot {
                bottom: 3px;
                left: -6px;
                width: 5px;
                height: 5px;
            }

            .note-indicator {
                bottom: 2px;
                width: 24px;
            }
        }

        .cell-bottom-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2px;
            margin-top: 1px;
            width: 100%;
            overflow: hidden;
            /* Mencegah melebar keluar kotak */
        }

        .pasaran-text {
            font-size: 0.4rem;
            font-weight: 700;
            opacity: 0.8;
            text-transform: uppercase;
            margin: 0 !important;
            white-space: nowrap;
            /* Mencegah teks turun baris */
            letter-spacing: -0.05em;
            /* Huruf dirapatkan sedikit */
        }

        /* Badge Tanggal 1 Hijriah */
        .hijri-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 12px;
            /* Perkecil sedikit */
            height: 12px;
            border-radius: 50%;
            color: white;
            font-size: 0.35rem;
            /* Font dalam lingkaran diperkecil */
            font-weight: 800;
            line-height: 1;
            flex-shrink: 0;
            /* Agar lingkaran tidak gepeng */
        }

        /* Teks Hijriah Biasa */
        .hijri-text {
            font-size: 0.4rem;
            font-weight: 700;
            opacity: 0.8;
            position: static !important;
            margin: 0 !important;
        }

        .hidden-element {
            display: none !important;
        }

        .holiday-item,
        .observance-item,
        .birthday-item,
        .anniversary-item,
        .note-item {
            padding: 0.85rem 1rem;
            background: #ffffff;
            border-radius: 16px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .holiday-item {
            border-left: 4px solid #ef4444;
        }

        .observance-item {
            border-left: 4px solid #3b82f6;
        }

        .birthday-item {
            background: #fffbeb;
            border-left: 4px solid #d97706;
        }

        .anniversary-item {
            background: #fdf2f8;
            border-left: 4px solid #be185d;
        }

        .note-item {
            background: #f0fdf4;
            border-left: 4px solid #10b981;
        }

        .highlight-today {
            background-color: #fef9c3 !important;
            box-shadow: 0 4px 6px -1px rgba(250, 204, 21, 0.1), 0 2px 4px -1px rgba(250, 204, 21, 0.06) !important;
            transform: scale(1.02);
            z-index: 5;

            /* --- PERBAIKAN DI SINI --- */
            /* Kita hanya beri garis kuning di Atas, Kanan, Bawah. */
            /* Kiri TIDAK disentuh agar warna identitas (Merah/Biru/Hijau) tetap muncul */
            border-top: 1px solid #fde047;
            border-right: 1px solid #fde047;
            border-bottom: 1px solid #fde047;
        }

        .event-list-container:empty::before {
            content: 'Tidak ada agenda bulan ini';
            display: block;
            text-align: center;
            color: #94a3b8;
            font-size: 0.8rem;
            margin-top: 2rem;
        }

        .footer-rhadzor {
            position: absolute;
            bottom: 0;
            width: 100%;
            padding: 1rem;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.75rem;
            z-index: 50;
            flex-shrink: 0;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
            display: none;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .modal-overlay.active {
            display: flex;
            opacity: 1;
        }

        /* KHUSUS MODAL MEPE ATAS (Bulan/Tahun/Cari) */
        .modal-overlay.pos-top {
            align-items: flex-start !important;
            padding-top: env(safe-area-inset-top, 0);
        }

        /* KHUSUS MODAL TENGAH (Preview & Detail Hari) */
        .modal-overlay.pos-center {
            align-items: center !important;
            justify-content: center !important;
            padding: 1rem !important;
            /* Diperkecil agar ruang konten lebih luas */
        }

        .modal-overlay.pos-center .modal-content {
            margin: auto !important;
            width: 94% !important;
            /* Dibuka lebih lebar sesuai request user */
            max-width: 480px !important;
            border-radius: 32px !important;
            transform: scale(0.9) !important;
            max-height: 85vh !important;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5) !important;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-overlay.pos-center.active .modal-content {
            transform: scale(1) !important;
        }

        .modal-overlay.pos-top .modal-content {
            margin-top: 0 !important;
        }

        @media (max-width: 1023px) {
            .modal-overlay {
                align-items: flex-end;
            }

            .modal-overlay.pos-top .modal-content {
                border-top-left-radius: 0;
                border-top-right-radius: 0;
                border-bottom-left-radius: 28px;
                border-bottom-right-radius: 28px;
                transform: translateY(-100%);
                margin-bottom: auto !important;
                /* Paksa ke atas */
            }

            .modal-overlay.pos-top.active .modal-content {
                transform: translateY(0) !important;
            }

            .modal-content {
                background: white;
                width: 100%;
                max-width: 448px;
                margin: 0 auto;
                border-top-left-radius: 28px;
                border-top-right-radius: 28px;
                padding: 1.5rem;
                transform: translateY(100%);
                transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
                max-height: 80vh;
                overflow-y: auto;
            }

            .modal-overlay.active .modal-content {
                transform: translateY(0);
            }
        }

        @media (min-width: 1024px) {
            .modal-overlay {
                align-items: center;
                justify-content: center;
            }

            .modal-content {
                background: white;
                width: 400px;
                border-radius: 24px;
                padding: 2rem;
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
                transform: scale(0.9);
                transition: transform 0.2s;
            }

            .modal-overlay.active .modal-content {
                transform: scale(1);
            }

            .modal-header-line {
                display: none;
            }
        }

        .modal-header-line {
            width: 48px;
            height: 6px;
            background: #e2e8f0;
            border-radius: 99px;
            margin: 0 auto 1.5rem auto;
        }

        .desktop-header-controls {
            display: none;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e2e8f0;
        }

        @media (min-width: 1024px) {
            .desktop-header-controls {
                display: flex;
            }
        }

        .toggle-switch {
            appearance: none;
            width: 40px;
            height: 22px;
            background: #cbd5e1;
            border-radius: 99px;
            position: relative;
            cursor: pointer;
            transition: background 0.2s;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            transition: transform 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .toggle-switch:checked {
            background: var(--accent-color);
        }

        .toggle-switch:checked::after {
            transform: translateX(18px);
        }

        .premium-select {
            width: 100%;
            padding: 0.75rem 1rem;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
            color: #1e293b;
            outline: none;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748b'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1rem;
        }

        /* SCROLLER FIX: Hiding scrollbars across all scroller types */
        .scroller-wrapper {
            position: relative;
            height: 200px;
            overflow: hidden;
            display: flex;
            mask-image: linear-gradient(to bottom, transparent, black 20%, black 80%, transparent);
            -webkit-mask-image: linear-gradient(to bottom, transparent, black 20%, black 80%, transparent);
        }

        .scroller-col {
            flex: 1;
            overflow-y: auto;
            padding: 75px 0;
            text-align: center;
            scroll-snap-type: y mandatory;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .scroller-col::-webkit-scrollbar {
            display: none;
        }

        .scroller-item {
            padding: 10px;
            font-size: 1.1rem;
            color: #94a3b8;
            cursor: pointer;
            opacity: 0.5;
            scroll-snap-align: center;
        }

        .scroller-item.active {
            font-size: 1.5rem;
            font-weight: 800;
            color: #0f172a;
            opacity: 1;
            transform: scale(1.1);
        }

        .selection-indicator {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 50px;
            transform: translateY(-50%);
            border-top: 1px solid #e2e8f0;
            border-bottom: 1px solid #e2e8f0;
            pointer-events: none;
            z-index: -1;
        }

        /* Ensure infinite scroll containers also hide scrollbars */
        #scrollDay,
        #scrollMonth,
        #scrollYear,
        #yearListScroll,
        #monthScroller,
        #yearScroller {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        #scrollDay::-webkit-scrollbar,
        #scrollMonth::-webkit-scrollbar,
        #scrollYear::-webkit-scrollbar,
        #yearListScroll::-webkit-scrollbar,
        #monthScroller::-webkit-scrollbar,
        #yearScroller::-webkit-scrollbar {
            display: none;
        }

        /* Notes View Styles */
        .notes-view-container {
            display: none;
            flex-direction: column;
            height: 100%;
            background: #f8fafc;
        }

        .notes-view-container.active {
            display: flex;
        }

        .notes-tab-group {
            display: flex;
            background: #e2e8f0;
            padding: 4px;
            border-radius: 12px;
            margin: 1rem 1.5rem 0.5rem 1.5rem;
        }

        .notes-tab {
            flex: 1;
            text-align: center;
            padding: 8px;
            font-size: 0.75rem;
            font-weight: 700;
            border-radius: 8px;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s;
        }

        .notes-tab.active {
            background: white;
            color: #0f172a;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .notes-nav-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1.5rem;
        }

        /* Pastikan body tidak mendorong konten keluar dari area aman */
        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            /* Mengikuti tema terpilih */
        }

        .header-rhadzor {
            /* Gunakan gradient dari tema aktif */
            background: var(--premium-gradient) !important;

            /* Menghapus tinggi kaku, biarkan padding yang bekerja */
            height: auto !important;
            min-height: 60px;

            /* Ruang untuk status bar (Jam, Baterai) */
            padding-top: env(safe-area-inset-top) !important;
            padding-bottom: 10px;

            display: flex;
            align-items: center;
            justify-content: center;
        }

        .footer-rhadzor {
            /* Gunakan gradient dari tema aktif */
            background: var(--premium-gradient) !important;

            height: auto !important;
            /* Ruang bawah agar navigasi HP tidak menutupi ikon */
            padding-bottom: calc(10px + env(safe-area-inset-bottom)) !important;
            padding-top: 10px;

            display: flex;
            align-items: center;
        }

        /* --- CSS KHUSUS MODAL POSISI ATAS (HEADER) --- */
        .modal-overlay.pos-top {
            align-items: flex-start !important;
            /* Paksa konten nempel di atas */
            padding-top: 85px;
            /* Memberi jarak agar tidak menutupi Header */
        }

        /* Mengubah animasi dan bentuk sudut untuk modal atas */
        .modal-overlay.pos-top .modal-content {
            border-radius: 0 0 24px 24px !important;
            /* Melengkung di bawah, rata di atas */
            transform: translateY(-100%);
            /* Animasi mulai dari atas layar (tersembunyi) */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            max-height: 60vh;
            /* Membatasi tinggi agar tidak terlalu panjang */
        }

        /* Saat aktif, turun ke posisi normal */
        .modal-overlay.pos-top.active .modal-content {
            transform: translateY(0);
        }

        /* --- CSS MODE GELAP (DARK MODE) --- */
        body.dark-mode {
            background-color: #0f172a !important;
            /* Latar belakang utama gelap */
            color: #f1f5f9;
        }

        /* Mengubah semua elemen yang tadinya Putih/Terang menjadi Gelap */
        body.dark-mode .app-container,
        body.dark-mode .main-content,
        body.dark-mode .calendar-card,
        body.dark-mode .calendar-section-mobile,
        body.dark-mode .info-section-mobile,
        body.dark-mode .modal-content,
        body.dark-mode .bg-white,
        body.dark-mode .bg-slate-50,
        body.dark-mode .bg-slate-100 {
            background-color: #1e293b !important;
            /* Slate 800 */
            color: #f1f5f9 !important;
            border-color: #334155 !important;
        }

        /* Memperbaiki warna teks yang dipaksa gelap oleh Tailwind */
        body.dark-mode .text-slate-900,
        body.dark-mode .text-slate-800,
        body.dark-mode .text-slate-700,
        body.dark-mode .text-slate-600,
        body.dark-mode .text-slate-500,
        body.dark-mode .text-gray-600 {
            color: #cbd5e1 !important;
            /* Slate 300 (Terang) */
        }

        /* Input Form & Textarea */
        body.dark-mode input,
        body.dark-mode textarea,
        body.dark-mode select,
        body.dark-mode .premium-select {
            background-color: #334155 !important;
            /* Slate 700 */
            color: white !important;
            border-color: #475569 !important;
        }

        /* Item List (Libur, Note, dll) */
        body.dark-mode .holiday-item,
        body.dark-mode .observance-item,
        body.dark-mode .note-item,
        body.dark-mode .birthday-item,
        body.dark-mode .anniversary-item {
            background-color: #334155 !important;
            border-bottom: 1px solid #475569;
            box-shadow: none !important;
        }

        /* Tombol Pilihan Bulan/Tahun */
        body.dark-mode .scroller-item {
            color: #64748b;
            /* Item tidak aktif */
        }

        body.dark-mode .scroller-item.active {
            color: #ffffff !important;
            /* Item aktif jadi putih */
        }

        /* --- UPDATE FIX: WARNA TANGGAL DI MODE GELAP --- */

        /* 1. Tanggal Normal (Senin-Kamis/Sabtu) jadi Putih */
        body.dark-mode .day-cell {
            color: #f8fafc !important;
            /* Slate-50 (Putih Bersih) */
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
            /* Sedikit bayangan biar makin jelas */
        }

        /* 2. Pasaran & Hijriah jadi Abu Terang */
        body.dark-mode .pasaran-text,
        body.dark-mode .hijri-text {
            color: #cbd5e1 !important;
            /* Slate-300 */
            opacity: 1 !important;
            /* Opacity dipullkan agar terbaca */
        }

        /* 3. Khusus Tanggal Merah (Minggu/Libur) - Ubah Merah Gelap jadi Merah Terang (Pastel) */
        body.dark-mode .day-cell.sunday,
        body.dark-mode .day-cell.holiday {
            color: #f87171 !important;
            /* Red-400 (Lebih terang dari default) */
        }

        /* 4. Khusus Hari Jumat - Ubah Hijau Gelap jadi Hijau Terang */
        body.dark-mode .day-cell.friday {
            color: #34d399 !important;
            /* Emerald-400 */
        }

        /* 5. Nama Hari (MINGGU, SENIN...) di header kalender */
        body.dark-mode .day-label {
            color: #94a3b8 !important;
            /* Slate-400 */
        }

        /* 6. Judul Bulan/Tahun di Detail Modal (Penting saat pop-up muncul) */
        body.dark-mode .text-slate-900 {
            color: #f1f5f9 !important;
        }

        body.dark-mode .text-slate-500 {
            color: #94a3b8 !important;
        }

        /* --- UPDATE FIX: CATATANKU DARK MODE --- */

        /* 1. Background Container Utama */
        body.dark-mode .notes-view-container {
            background-color: #0f172a !important;
            /* Gelap pekat */
        }

        /* 2. Group Tab (Wadah Tombol Mingguan/Bulanan) */
        body.dark-mode .notes-tab-group {
            background-color: #1e293b !important;
            /* Slate 800 */
            border: 1px solid #334155;
            /* Border halus */
        }

        /* 3. Tab Item (Saat Tidak Aktif) */
        body.dark-mode .notes-tab {
            color: #94a3b8 !important;
            /* Teks abu */
        }

        /* 4. Tab Item (Saat Aktif) */
        body.dark-mode .notes-tab.active {
            background-color: #334155 !important;
            /* Slate 700 (Lebih terang dikit) */
            color: #f8fafc !important;
            /* Teks putih */
            box-shadow: none !important;
        }

        /* 5. Navigasi Atas (Label "Minggu Ini", Tombol Panah) */
        body.dark-mode #notesNavLabel {
            color: #f1f5f9 !important;
            /* Judul putih */
        }

        body.dark-mode .notes-nav-bar button {
            background-color: #334155 !important;
            /* Tombol panah gelap */
            color: #cbd5e1 !important;
        }

        /* 6. KARTU CATATAN (List Item) */
        /* Override untuk elemen yang dibuat via JavaScript */
        body.dark-mode #notesListContainer>div {
            background-color: #1e293b !important;
            /* Background kartu gelap */
            box-shadow: none !important;
            border: 1px solid #334155;
            /* Tambah border agar terpisah jelas */
            border-left: 4px solid #10b981 !important;
            /* Border hijau tetap */
        }

        /* Efek Hover pada Kartu Catatan */
        body.dark-mode #notesListContainer>div:hover {
            background-color: #334155 !important;
        }

        /* Teks Tanggal & Ikon Edit di dalam kartu */
        body.dark-mode #notesListContainer .text-slate-500,
        body.dark-mode #notesListContainer .text-slate-300 {
            color: #94a3b8 !important;
            /* Abu terang */
        }

        /* Teks Isi Catatan Utama */
        body.dark-mode #notesListContainer .text-slate-700 {
            color: #e2e8f0 !important;
            /* Putih agak abu (enak dibaca) */
        }

        /* 7. Empty State (Saat tidak ada catatan) */
        body.dark-mode #notesListContainer .fa-clipboard-list {
            color: #334155 !important;
            /* Ikon besar jadi samar gelap */
        }
    </style>
</head>

<body>

    <div class="app-container">

        <!-- === LEFT SIDEBAR (DESKTOP) === -->
        <div class="desktop-sidebar">
            <div>
                <div class="flex items-center gap-3 mb-8">
                    <div
                        class="w-10 h-10 bg-white rounded-lg flex items-center justify-center text-slate-900 font-black text-xl shadow-lg">
                        R</div>
                    <div>
                        <h1 class="font-bold text-lg leading-none tracking-widest">KALENDER INDONESIA</h1>
                    </div>
                </div>

                <div class="space-y-4 mb-8">
                    <p class="text-xs font-bold opacity-50 uppercase tracking-widest mb-2">Tampilan</p>
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-medium opacity-90">Hari Pasaran</span>
                        <input type="checkbox" class="toggle-switch" id="dsk-pasaran"
                            onchange="toggleSetting('showPasaran')">
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-medium opacity-90">Kalender Hijriah</span>
                        <input type="checkbox" class="toggle-switch" id="dsk-hijri"
                            onchange="toggleSetting('showHijri')">
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-medium opacity-90">Hari Peringatan Nasional</span>
                        <input type="checkbox" class="toggle-switch" id="dsk-obs"
                            onchange="toggleSetting('showObservances')">
                    </div>
                </div>

                <div class="space-y-2 mb-8">
                    <p class="text-xs font-bold opacity-50 uppercase tracking-widest mb-1">Tema Warna</p>
                    <button onclick="cycleTheme()"
                        class="w-full bg-white/10 hover:bg-white/20 transition p-2 rounded-xl flex items-center justify-between px-4 font-bold text-sm">
                        <span id="themeNameDesktop">Royal Blue</span>
                        <i class="fas fa-palette"></i>
                    </button>
                </div>

                <div class="space-y-2 mb-8">
                    <p class="text-xs font-bold opacity-50 uppercase tracking-widest mb-1">Efek Transisi</p>
                    <select class="premium-select" id="transitionSelect" onchange="updateTransition(this.value)">
                        <option value="none">None (Instant)</option>
                        <option value="slide">Slide (Klasik)</option>
                        <option value="cube">Cube Flip (3D)</option>
                        <option value="fade">Fade (Lembut)</option>
                        <option value="zoom">Zoom In/Out</option>
                        <option value="flip">Flip Card</option>
                    </select>
                </div>

                <button onclick="goToToday()"
                    class="w-full bg-white/10 hover:bg-white/20 transition p-3 rounded-xl flex items-center justify-center gap-2 mb-2 font-bold text-sm">
                    <i class="fas fa-calendar-day"></i> Hari Ini
                </button>
                <button onclick="openDateSearch()"
                    class="w-full bg-white/10 hover:bg-white/20 transition p-3 rounded-xl flex items-center justify-center gap-2 font-bold text-sm">
                    <i class="fas fa-search"></i> Cari Tanggal
                </button>
            </div>

            <div class="text-center opacity-40 text-xs">
                &copy; Rhadz Calendar
            </div>
        </div>

        <!-- === HEADER (MOBILE ONLY) === -->
        <header class="header-rhadzor" id="mainHeader">
            <div class="header-left">
                <div class="btn-setting" onclick="openSettings()">
                    <i class="fas fa-cog"></i>
                </div>
            </div>
            <div class="header-center" id="calendarHeaderCenter">
                <div class="flex items-center gap-2">
                    <div class="nav-arrow" onclick="changeMonth(-1)"><i class="fas fa-chevron-left"></i></div>
                    <div class="month-year-title">
                        <span id="monthLabelMobile" onclick="openMonthSelector()">JANUARI</span>
                        <span id="yearLabelMobile" onclick="openYearSelector()">2026</span>
                    </div>
                    <div class="nav-arrow" onclick="changeMonth(1)"><i class="fas fa-chevron-right"></i></div>
                </div>
                <div class="hijri-label" id="hijriRangeMobile">RAJAB - SYA'BAN</div>
            </div>
            <div class="header-center hidden" id="notesHeaderCenter">
                <span class="font-bold tracking-widest uppercase text-sm">CATATANKU</span>
            </div>
            <div class="header-right">
                <div class="btn-today-icon" onclick="goToToday()">
                    <i class="fas fa-calendar-day text-sm"></i>
                </div>
            </div>
        </header>

        <!-- === MAIN CONTENT === -->
        <main class="main-content">

            <div class="desktop-header-controls">
                <div>
                    <h2 class="text-3xl font-black text-slate-800 tracking-tight" id="desktopMonthYear">JANUARI 2026
                    </h2>
                    <p class="text-sm text-slate-500 font-medium tracking-widest uppercase mt-1" id="desktopHijri">1447
                        HIJRIAH</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="changeMonth(-1)"
                        class="w-10 h-10 rounded-full bg-slate-100 hover:bg-slate-200 flex items-center justify-center text-slate-700 transition"><i
                            class="fas fa-chevron-left"></i></button>
                    <button onclick="changeMonth(1)"
                        class="w-10 h-10 rounded-full bg-slate-100 hover:bg-slate-200 flex items-center justify-center text-slate-700 transition"><i
                            class="fas fa-chevron-right"></i></button>
                </div>
            </div>

            <!-- VIEW 1: CALENDAR (DEFAULT) -->
            <div id="calendarViewContainer" class="flex flex-col h-full">
                <!-- WRAPPER KALENDER (STATIS DI MOBILE) -->
                <div class="calendar-section-mobile">
                    <div class="calendar-card" id="swipeArea">
                        <div class="calendar-grid-container" id="gridContainer">
                            <div class="calendar-grid" id="calendarGrid"></div>
                        </div>
                    </div>
                </div>

                <!-- WRAPPER KETERANGAN (SCROLL DI MOBILE) -->
                <div class="info-section-mobile" id="mobileInfoSection">
                    <div class="space-y-2 mt-2" id="holidayContainerMobile"></div>
                    <div class="quote-minimalist mt-8 text-center px-4 pb-8">
                        <p class="text-xs text-slate-500 italic" id="quoteDisplayMobile">"Kata bijak di sini"</p>
                    </div>
                </div>
            </div>

            <!-- VIEW 2: NOTES (HIDDEN DEFAULT) -->
            <div id="notesViewContainer" class="notes-view-container">
                <div class="notes-tab-group">
                    <div class="notes-tab active" onclick="switchNoteTab('weekly', this)">MINGGUAN</div>
                    <div class="notes-tab" onclick="switchNoteTab('monthly', this)">BULANAN</div>
                    <div class="notes-tab" onclick="switchNoteTab('yearly', this)">TAHUNAN</div>
                </div>

                <div class="notes-nav-bar">
                    <button onclick="navNotes(-1)"
                        class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-200 text-slate-600"><i
                            class="fas fa-chevron-left text-xs"></i></button>
                    <span id="notesNavLabel" class="text-sm font-bold text-slate-800 uppercase tracking-wide">MINGGU
                        INI</span>
                    <button onclick="navNotes(1)"
                        class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-200 text-slate-600"><i
                            class="fas fa-chevron-right text-xs"></i></button>
                </div>

                <div id="notesListContainer" class="flex-1 overflow-y-auto p-4 space-y-3 pb-24">
                    <!-- Notes will be injected here -->
                </div>
            </div>

        </main>

        <!-- === RIGHT PANEL (DESKTOP) === -->
        <div class="desktop-right-panel">
            <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-4">Agenda Bulan Ini</h3>

            <div id="holidayContainerDesktop" class="space-y-3 event-list-container flex-1">
            </div>

            <div class="mt-auto pt-6 border-t border-slate-200">
                <i class="fas fa-quote-left text-slate-300 text-lg mb-2 block"></i>
                <p class="text-sm italic text-slate-600 font-medium leading-relaxed" id="quoteDisplayDesktop">Loading
                    quote...</p>
            </div>
        </div>

        <!-- FOOTER (MOBILE ONLY) -->
        <footer class="footer-rhadzor lg:hidden">
            <!-- Left Button: View Switcher -->
            <div id="footerLeftBtn" onclick="toggleNotesView()"
                class="w-10 h-10 flex items-center justify-center rounded-full bg-white/10 active:bg-white/20 transition cursor-pointer">
                <i class="fas fa-book text-white text-sm"></i>
            </div>

            <!-- Center: Branding -->
            <div class="flex items-center gap-2">
                <span class="text-sm font-bold tracking-widest text-white uppercase">KALENDER INDONESIA</span>
            </div>

            <!-- Right Button: Action -->
            <div id="footerRightBtn" onclick="handleFooterRightAction()"
                class="w-10 h-10 flex items-center justify-center rounded-full bg-white/10 active:bg-white/20 transition cursor-pointer">
                <i class="fas fa-search text-white text-sm"></i>
            </div>
        </footer>
    </div>

    <div class="modal-overlay" id="selectorModal" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header-line"></div>
            <h3 id="modalTitle"
                class="text-center font-bold text-slate-800 mb-4 uppercase text-xs tracking-widest hidden">JUDUL MODAL
            </h3>

            <div id="modalBodyWrapper" class="flex-1 overflow-hidden flex flex-col">
                <div id="modalBody" class="w-full"></div>
            </div>
        </div>
    </div>

    <script>
        if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js');
        }
        // --- DATABASE ---
        const quotes = [
            "Semakin kita mencari kebahagiaan, semakin jauh ia menghilang.", "Kegagalan terbesar adalah tidak pernah mencoba.", "Kata-kata terlembut bisa melukai paling dalam.", "Kita belajar paling banyak dari orang yang paling kita benci.", "Diam terkadang lebih berisik daripada teriakan.", "Kehilangan mengajarkan kita nilai memiliki.", "Kesendirian ramai, keramaian bisa sangat sunyi.", "Menerima adalah cara terkuat untuk melawan.", "Kita paling kuat saat mengakui kelemahan.", "Berubah adalah satu-satunya yang tetap.", "Makin banyak tahu, makin sadar tak tahu apa-apa.", "Waktu sembuhkan luka, waktu juga ciptakan luka.", "Cinta membebaskan dengan cara mengikat.", "Kesederhanaan butuh usaha yang rumit.", "Memberi adalah cara terbaik menerima.", "Memaafkan membebaskan yang memaafkan.", "Ketakutan terbesar adalah takut itu sendiri.", "Kontrol dimulai dari melepas kontrol.", "Kematian memberi arti pada kehidupan.", "Harapan bisa menjadi belenggu tersendiri.", "Kebenaran menyakitkan lebih baik dari kebohongan manis.", "Kesalahan masa lalu adalah guru terbaik hari ini.", "Semakin keras kita pegang, semakin mudah lepas.", "Pertanyaan lebih berharga daripada jawaban.", "Kegelapan mengajarkan kita menghargai cahaya.", "Kepastian adalah ilusi yang nyaman.", "Kita paling hidup saat hampir mati.", "Mendengar lebih sulit daripada berbicara.", "Kesuksesan dimulai dari kegagalan berulang.", "Kehilangan jalan adalah cara menemukan jalan baru.", "Keraguan adalah awal dari kebijaksanaan.", "Melambat terkadang cara tercepat sampai tujuan.", "Rasa sakit mengingatkan kita bahwa kita hidup.", "Mengenal diri sendiri adalah perjalanan seumur hidup.", "Kebahagiaan sejati datang dari dalam, bukan luar.", "Waktu tidak bisa dibeli tapi sering kita sia-siakan.", "Masalah terbesar sering punya solusi tersederhana.", "Kehilangan adalah bagian dari memiliki.", "Kesempurnaan adalah musuh dari kemajuan.", "Kita tumbuh paling cepat di luar zona nyaman.", "Yang kita takuti sering tidak pernah terjadi.", "Kebencian meracuni yang membenci.", "Berhenti adalah langkah maju terkadang.", "Mimpi tanpa aksi hanya angan-angan.", "Ketenangan lahir dari menerima kekacauan.", "Perpisahan mengajarkan arti kebersamaan.", "Kekuatan sejati adalah kelembutan.", "Hidup dimulai di ujung zona nyaman.", "Kesabaran adalah kekuatan yang tersembunyi.", "Melepas adalah bentuk kepemilikan tertinggi."
        ];

        const familyBirthdays = [];

        const weddingAnniversary = { day: null, month: null, year: null };

        const holidaysData = {
            2025: {
                0: { 1: "Tahun Baru 2025 Masehi", 27: "Isra Mikraj Nabi Muhammad SAW", 29: "Tahun Baru Imlek 2576 Kongzili" },
                2: { 29: "Hari Suci Nyepi (Tahun Baru Saka 1947)", 31: "Idul Fitri 1446 Hijriah" },
                3: { 1: "Idul Fitri 1446 Hijriah", 18: "Wafat Yesus Kristus", 20: "Kebangkitan Yesus Kristus (Paskah)" },
                4: { 1: "Hari Buruh Internasional", 12: "Hari Raya Waisak 2569 BE", 29: "Kenaikan Yesus Kristus" },
                5: { 1: "Hari Lahir Pancasila", 6: "Idul Adha 1446 Hijriah", 27: "1 Muharam Tahun Baru Islam 1447 Hijriah" },
                7: { 17: "Proklamasi Kemerdekaan RI" },
                8: { 5: "Maulid Nabi Muhammad SAW" },
                11: { 25: "Kelahiran Yesus Kristus (Natal)" }
            },
            2026: {
                0: { 1: "Tahun Baru 2026 Masehi", 16: "Isra Mikraj Nabi Muhammad SAW" },
                1: { 17: "Tahun Baru Imlek 2577 Kongzili" },
                2: { 19: "Hari Suci Nyepi (Tahun Baru Saka 1948)", 21: "Idul Fitri 1447 Hijriah", 22: "Idul Fitri 1447 Hijriah" },
                3: { 3: "Wafat Yesus Kristus", 5: "Kebangkitan Yesus Kristus (Paskah)" },
                4: { 1: "Hari Buruh Internasional", 14: "Kenaikan Yesus Kristus", 27: "Idul Adha 1447 Hijriah", 31: "Hari Raya Waisak 2570 BE" },
                5: { 1: "Hari Lahir Pancasila", 16: "1 Muharam Tahun Baru Islam 1448 Hijriah" },
                7: { 17: "Proklamasi Kemerdekaan RI", 25: "Maulid Nabi Muhammad SAW" },
                11: { 25: "Kelahiran Yesus Kristus (Natal)" }
            }
        };

        const cutiBersamaData = {
            2025: {
                0: { 28: "Cuti Bersama Imlek 2576" },
                2: { 28: "Cuti Bersama Nyepi Saka 1947" },
                3: { 2: "Cuti Bersama Idul Fitri", 3: "Cuti Bersama Idul Fitri", 4: "Cuti Bersama Idul Fitri", 7: "Cuti Bersama Idul Fitri" },
                4: { 13: "Cuti Bersama Waisak", 30: "Cuti Bersama Kenaikan Yesus Kristus" },
                5: { 9: "Cuti Bersama Idul Adha" },
                7: { 18: "Cuti Bersama Proklamasi Kemerdekaan" },
                11: { 26: "Cuti Bersama Natal" }
            },
            2026: {
                1: { 16: "Cuti Bersama Imlek 2577" },
                2: { 18: "Cuti Bersama Nyepi Saka 1948", 20: "Cuti Bersama Idul Fitri", 23: "Cuti Bersama Idul Fitri", 24: "Cuti Bersama Idul Fitri" },
                4: { 15: "Cuti Bersama Kenaikan Yesus Kristus", 28: "Cuti Bersama Idul Adha" },
                11: { 24: "Cuti Bersama Natal" }
            }
        };

        const nationalObservances = {
            0: { 3: "Hari Amal Bhakti Kemenag RI", 5: "Hari KOWAL", 10: "Hari Tritura", 15: "Hari Dharma Samudera", 17: "Hari Raya Siwaratri", 23: "Hari Patriotik", 25: "Hari Gizi Nasional", 31: "Harlah NU" },
            1: { 5: "Peristiwa Kapal Tujuh", 9: "Hari Pers Nasional (HPN)", 14: "Peringatan PETA", 21: "Hari Peduli Sampah Nasional", 28: "Hari Gizi Nasional" },
            2: { 1: "Serangan Umum 1 Maret", 9: "Hari Musik Nasional", 30: "Hari Film Nasional" },
            3: { 6: "Hari Nelayan Indonesia", 9: "Hari TNI AU", 16: "Hari Kopassus", 21: "Hari Kartini", 27: "Hari Pemasyarakatan", 28: "Hari Puisi Nasional" },
            4: { 2: "Hardiknas", 17: "Hari Buku Nasional", 20: "Hari Kebangkitan Nasional", 29: "Hari Lanjut Usia Nasional" },
            5: { 21: "Hari Krida Pertanian", 24: "Hari Bidan Nasional", 29: "Hari KB" },
            6: { 1: "Hari Bhayangkara", 5: "Hari Bank Indonesia", 12: "Hari Koperasi Indonesia", 22: "Hari Kejaksaan", 23: "Hari Anak Nasional" },
            7: { 5: "Hari Dharma Wanita", 10: "Hari Veteran Nasional", 14: "Hari Pramuka", 21: "Hari Maritim Nasional", 24: "Hari TVRI" },
            8: { 1: "Hari Polwan", 3: "Hari PMI", 4: "Hari Pelanggan Nasional", 9: "Hari Olahraga Nasional", 17: "Hari Perhubungan Nasional", 24: "Hari Tani Nasional", 28: "Hari Kereta Api", 30: "Peringatan G30S/PKI" },
            9: { 1: "Hari Kesaktian Pancasila", 2: "Hari Batik Nasional", 5: "Hari TNI", 24: "Hari Dokter Indonesia", 27: "Hari Listrik Nasional", 28: "Hari Sumpah Pemuda", 30: "Hari Keuangan Nasional" },
            10: { 5: "Hari Cinta Puspa & Satwa", 10: "Hari Pahlawan", 12: "Hari Kesehatan / Hari Ayah", 14: "Hari Brimob", 25: "Hari Guru", 28: "Hari Menanam Pohon", 29: "Hari KORPRI" },
            11: { 12: "Hari Transmigrasi", 13: "Hari Nusantara", 19: "Hari Bela Negara", 22: "Hari Ibu" }
        };

        const hijriMonths = ["MUHARRAM", "SAFAR", "RABIUL AWAL", "RABIUL AKHIR", "JUMADIL AWAL", "JUMADIL AKHIR", "RAJAB", "SYA'BAN", "RAMADHAN", "SYAWAL", "DZULQA'DAH", "DZULHIJJAH"];
        const pasaranArr = ["LEGI", "PAHING", "PON", "WAGE", "KLIWON"];
        const monthNames = ["JANUARI", "FEBRUARI", "MARET", "APRIL", "MEI", "JUNI", "JULI", "AGUSTUS", "SEPTEMBER", "OKTOBER", "NOVEMBER", "DESEMBER"];
        const dayNames = ["MINGGU", "SENIN", "SELASA", "RABU", "KAMIS", "JUMAT", "SABTU"];
        const dayShortNames = ["MGG", "SEN", "SEL", "RAB", "KAM", "JUM", "SAB"];

        // --- DATABASE TANGGAL HIJRIAH (FIXED) ---
        // Format: Bulan (0=Januari), Tanggal, Tahun Masehi => Bulan Hijriah (0=Muharram), Tahun Hijriah
        // Data berdasarkan input user (2024-2026)
        const hijriAnchors = [
            // 1445 H
            { d: 13, m: 0, y: 2024, hM: 6, hY: 1445 },  // 1 Rajab
            { d: 11, m: 1, y: 2024, hM: 7, hY: 1445 },  // 1 Sya'ban
            { d: 12, m: 2, y: 2024, hM: 8, hY: 1445 },  // 1 Ramadhan
            { d: 10, m: 3, y: 2024, hM: 9, hY: 1445 },  // 1 Syawal
            { d: 10, m: 4, y: 2024, hM: 10, hY: 1445 }, // 1 Dzulqa'dah
            { d: 8, m: 5, y: 2024, hM: 11, hY: 1445 },  // 1 Dzulhijjah

            // 1446 H
            { d: 7, m: 6, y: 2024, hM: 0, hY: 1446 },   // 1 Muharram
            { d: 6, m: 7, y: 2024, hM: 1, hY: 1446 },   // 1 Safar
            { d: 5, m: 8, y: 2024, hM: 2, hY: 1446 },   // 1 Rabiul Awal
            { d: 4, m: 9, y: 2024, hM: 3, hY: 1446 },   // 1 Rabiul Akhir
            { d: 3, m: 10, y: 2024, hM: 4, hY: 1446 },  // 1 Jumadil Awal
            { d: 3, m: 11, y: 2024, hM: 5, hY: 1446 },  // 1 Jumadil Akhir
            { d: 1, m: 0, y: 2025, hM: 6, hY: 1446 },   // 1 Rajab
            { d: 31, m: 0, y: 2025, hM: 7, hY: 1446 },  // 1 Sya'ban
            { d: 1, m: 2, y: 2025, hM: 8, hY: 1446 },   // 1 Ramadhan
            { d: 31, m: 2, y: 2025, hM: 9, hY: 1446 },  // 1 Syawal
            { d: 29, m: 3, y: 2025, hM: 10, hY: 1446 }, // 1 Dzulqa'dah
            { d: 28, m: 4, y: 2025, hM: 11, hY: 1446 }, // 1 Dzulhijjah

            // 1447 H
            { d: 27, m: 5, y: 2025, hM: 0, hY: 1447 },  // 1 Muharram
            { d: 26, m: 6, y: 2025, hM: 1, hY: 1447 },  // 1 Safar
            { d: 25, m: 7, y: 2025, hM: 2, hY: 1447 },  // 1 Rabiul Awal
            { d: 23, m: 8, y: 2025, hM: 3, hY: 1447 },  // 1 Rabiul Akhir
            { d: 23, m: 9, y: 2025, hM: 4, hY: 1447 },  // 1 Jumadil Awal
            { d: 22, m: 10, y: 2025, hM: 5, hY: 1447 }, // 1 Jumadil Akhir
            { d: 21, m: 11, y: 2025, hM: 6, hY: 1447 }, // 1 Rajab
            { d: 20, m: 0, y: 2026, hM: 7, hY: 1447 },  // 1 Sya'ban
            { d: 19, m: 1, y: 2026, hM: 8, hY: 1447 },  // 1 Ramadhan
            { d: 21, m: 2, y: 2026, hM: 9, hY: 1447 },  // 1 Syawal
            { d: 19, m: 3, y: 2026, hM: 10, hY: 1447 }, // 1 Dzulqa'dah
            { d: 18, m: 4, y: 2026, hM: 11, hY: 1447 }, // 1 Dzulhijjah

            // 1448 H
            { d: 16, m: 5, y: 2026, hM: 0, hY: 1448 },   // 1 Muharram
            { d: 16, m: 6, y: 2026, hM: 1, hY: 1448 },   // 1 Safar
            { d: 14, m: 7, y: 2026, hM: 2, hY: 1448 },   // 1 Rabi'ul-Awal
            { d: 13, m: 8, y: 2026, hM: 3, hY: 1448 },   // 1 Rabi'ul-Akhir
            { d: 12, m: 9, y: 2026, hM: 4, hY: 1448 },   // 1 Jumadil Awal
            { d: 11, m: 10, y: 2026, hM: 5, hY: 1448 },   // 1 Jumadil Akhir
            { d: 10, m: 11, y: 2026, hM: 6, hY: 1448 }   // 1 Rajab 
        ];

        // --- DATABASE TEMA (TOTAL 8 TEMA) ---
        const themes = [
            // 1. Royal Blue (Lama)
            { id: 'royal', name: 'Royal Blue', class: '', colorBg: 'bg-slate-900', ringColor: 'ring-blue-200', borderColor: 'border-blue-500' },
            // 2. Emerald (Lama)
            { id: 'emerald', name: 'Emerald', class: 'theme-emerald', colorBg: 'bg-emerald-700', ringColor: 'ring-emerald-200', borderColor: 'border-emerald-500' },
            // 3. Amethyst (Lama)
            { id: 'amethyst', name: 'Amethyst', class: 'theme-amethyst', colorBg: 'bg-purple-700', ringColor: 'ring-purple-200', borderColor: 'border-purple-500' },
            // 4. Crimson (Lama)
            { id: 'crimson', name: 'Crimson', class: 'theme-crimson', colorBg: 'bg-rose-700', ringColor: 'ring-rose-200', borderColor: 'border-rose-500' },

            // 5. Midnight (Baru)
            { id: 'midnight', name: 'Midnight Slate', class: 'theme-midnight', colorBg: 'bg-slate-700', ringColor: 'ring-slate-300', borderColor: 'border-slate-500' },
            // 6. Ocean (Baru)
            { id: 'ocean', name: 'Deep Ocean', class: 'theme-ocean', colorBg: 'bg-cyan-800', ringColor: 'ring-cyan-200', borderColor: 'border-cyan-500' },
            // 7. Sunset (Baru)
            { id: 'sunset', name: 'Sunset Orange', class: 'theme-sunset', colorBg: 'bg-orange-800', ringColor: 'ring-orange-200', borderColor: 'border-orange-500' },
            // 8. Coffee (Baru)
            { id: 'coffee', name: 'Elegant Coffee', class: 'theme-coffee', colorBg: 'bg-amber-900', ringColor: 'ring-amber-200', borderColor: 'border-amber-500' }
        ];
        let currentThemeIndex = 0;

        let currentDate = new Date();
        let isAnimating = false;
        let highlightTriggered = false;
        let isNotesView = false;

        let currentNoteMode = 'weekly';
        let currentNoteDate = new Date();

        // Mengambil data dari localStorage, jika kosong pakai default
        let settings = JSON.parse(localStorage.getItem('rhadzCalSettings')) || {
            showHijri: true,
            showPasaran: true,
            showObservances: true,
            showFamily: true,
            transitionType: 'none',
            darkMode: false // TAMBAHAN BARU
        };
        // Fungsi pembantu untuk menyimpan setiap ada perubahan
        function saveSettingsToStorage() {
            localStorage.setItem('rhadzCalSettings', JSON.stringify(settings));
        };
        function updateTransition(val) {
            settings.transitionType = val;
            saveSettingsToStorage(); // Simpan pilihan transisi ke memori
        }

        // HISTORY API HANDLER: Mengatur Tombol Back HP
        window.onpopstate = function (event) {
            const hash = location.hash;
            const modal = document.getElementById('selectorModal');

            // PRIORITAS 1: Jika MODAL terbuka, tutup modalnya saja.
            if (modal && modal.classList.contains('active')) {
                // hash !== '#modal' berarti user tekan back saat modal terbuka
                if (hash !== '#modal') {
                    closeModal(true);
                    return;
                }
            }

            // PRIORITAS 2: Jika halaman NOTES terbuka
            if (typeof isNotesView !== 'undefined' && isNotesView) {
                // Jika kita kembali ke #calendar (hash kosong atau #calendar), tutup Notes
                if (hash === '#calendar' || hash === '#home' || hash === '') {
                    toggleNotesView(true);
                    return;
                }
            }

            // PENGAMAN: Jika user entah bagaimana kembali ke root atau #home
            if (!hash || hash === '#home') {
                history.replaceState({ view: 'calendar' }, '', '#calendar');
            }
        };

        function init() {
            // 1. Terapkan Tema Warna
            const savedTheme = localStorage.getItem('rhadzThemeIndex');
            if (savedTheme !== null) applyTheme(parseInt(savedTheme));

            // 2. Terapkan Dark Mode
            if (settings.darkMode) document.body.classList.add('dark-mode');

            // 3. Sinkronkan tampilan menu
            syncSettingsUI();

            // 4. Render komponen utama
            renderCalendar();
            updateQuote();

            // 5. Setup History & Back Button (Insight User)
            // Kita paksa aplikasi mulai dari hash #calendar sebagai base entry.
            if (location.hash !== '#calendar' && location.hash !== '#notes') {
                history.replaceState({ view: 'calendar' }, '', '#calendar');
            } else if (location.hash === '#notes') {
                isNotesView = false;
                toggleNotesView(true);
            }

            // 6. Listener resize & swipe
            setupSwipe();
            window.addEventListener('resize', renderCalendar);

            // 7. Timeout transisi
            setTimeout(() => {
                const transSelect = document.getElementById('transitionSelect');
                if (transSelect) transSelect.value = settings.transitionType;
            }, 100);
        }

        function syncSettingsUI() {
            document.getElementById('dsk-pasaran').checked = settings.showPasaran;
            document.getElementById('dsk-hijri').checked = settings.showHijri;
            document.getElementById('dsk-obs').checked = settings.showObservances;
        }

        function cycleTheme() {
            currentThemeIndex = (currentThemeIndex + 1) % themes.length;
            applyTheme(currentThemeIndex);
        }

        function applyTheme(index) {
            currentThemeIndex = index;
            localStorage.setItem('rhadzThemeIndex', index); // Simpan pilihan tema

            const theme = themes[currentThemeIndex];

            // 1. Reset semua class dulu (ini yang bikin Dark Mode hilang)
            document.body.className = '';

            // 2. Pasang class tema warna baru (jika ada)
            if (theme.class) {
                document.body.classList.add(theme.class);
            }

            // --- PERBAIKAN DI SINI ---
            // 3. Cek apakah Mode Gelap sedang aktif? Jika ya, pasang lagi class-nya!
            if (settings.darkMode) {
                document.body.classList.add('dark-mode');
            }

            // 4. Update Label Nama Tema
            const desktopLabel = document.getElementById('themeNameDesktop');
            if (desktopLabel) desktopLabel.textContent = theme.name;

            const modalLabel = document.getElementById('themeNameModal');
            if (modalLabel) modalLabel.textContent = theme.name;

            // 5. Update Border Tombol di Modal
            themes.forEach((t, i) => {
                const btn = document.getElementById(`themeBtn-${i}`);
                if (btn) {
                    btn.className = `w-10 h-10 rounded-full border-2 transition ${t.colorBg} hover:scale-110 shadow-sm`;

                    if (i === index) {
                        btn.classList.add(t.borderColor, 'ring-2', t.ringColor);
                        btn.classList.remove('border-transparent');
                    } else {
                        btn.classList.add('border-transparent');
                    }
                }
            });
        }

        function getStoredNotes() {
            const stored = localStorage.getItem('rhadzCalNotes');
            let data = stored ? JSON.parse(stored) : {};

            // --- AUTO MIGRATION LOGIC ---
            // Cek apakah data masih format lama (String)? Jika ya, ubah ke Array Object
            let migrated = false;
            Object.keys(data).forEach(key => {
                if (typeof data[key] === 'string') {
                    // Konversi string lama menjadi object note pertama
                    data[key] = [{
                        id: Date.now() + Math.random(), // Random ID
                        text: data[key],
                        category: 'pribadi', // Default category
                        time: '',
                        isCompleted: false
                    }];
                    migrated = true;
                }
            });

            if (migrated) {
                localStorage.setItem('rhadzCalNotes', JSON.stringify(data));
            }

            return data;
        }

        // --- NEW CRUD OPERATIONS ---

        function addNote(dateKey, text, category = 'pribadi', time = '') {
            const notes = getStoredNotes();
            if (!notes[dateKey]) notes[dateKey] = [];

            notes[dateKey].push({
                id: Date.now(),
                text: text,
                category: category,
                time: time,
                isCompleted: false
            });

            localStorage.setItem('rhadzCalNotes', JSON.stringify(notes));
            renderCalendar(); // Update dot indikator
            renderNotesList(); // Update global list jika sedang dibuka
            return notes[dateKey]; // Return updated list
        }

        function deleteNote(dateKey, noteId) {
            const notes = getStoredNotes();
            if (notes[dateKey]) {
                notes[dateKey] = notes[dateKey].filter(n => n.id != noteId); // Pakai filter != karena ID bisa number/string dari JSON
                if (notes[dateKey].length === 0) delete notes[dateKey]; // Hapus key jika kosong

                localStorage.setItem('rhadzCalNotes', JSON.stringify(notes));
                renderCalendar();
                renderNotesList();
            }
            return notes[dateKey] || [];
        }

        function editNote(dateKey, noteId, newText, newCategory, newTime) {
            const notes = getStoredNotes();
            if (notes[dateKey]) {
                const note = notes[dateKey].find(n => n.id == noteId);
                if (note) {
                    note.text = newText;
                    note.category = newCategory;
                    note.time = newTime;
                    localStorage.setItem('rhadzCalNotes', JSON.stringify(notes));
                    renderCalendar();
                    renderNotesList();
                }
            }
            return notes[dateKey] || [];
        }

        function toggleNoteStatus(dateKey, noteId) {
            const notes = getStoredNotes();
            if (notes[dateKey]) {
                const note = notes[dateKey].find(n => n.id == noteId);
                if (note) {
                    note.isCompleted = !note.isCompleted;
                    localStorage.setItem('rhadzCalNotes', JSON.stringify(notes));
                    renderCalendar();
                    renderNotesList();
                }
            }
            return notes[dateKey] || [];
        }

        // --- BACKUP & RESTORE ---
        function exportData() {
            try {
                const data = {
                    settings: JSON.parse(localStorage.getItem('rhadzCalSettings')),
                    notes: JSON.parse(localStorage.getItem('rhadzCalNotes')),
                    themeIndex: localStorage.getItem('rhadzThemeIndex'),
                    ver: 'v10'
                };
                const json = JSON.stringify(data, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);

                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", url);
                downloadAnchorNode.setAttribute("download", "rhadz-backup-" + new Date().toISOString().slice(0, 10) + ".json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();

                // Cleanup
                setTimeout(() => {
                    if (document.body.contains(downloadAnchorNode)) {
                        document.body.removeChild(downloadAnchorNode);
                    }
                    URL.revokeObjectURL(url);
                }, 1000); // Bertahan lebih lama agar download sempat dipicu di Android
            } catch (e) {
                alert("Gagal melakukan backup: " + e.message);
            }
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);
                    console.log("Restoring data...", data);

                    if (data.settings) {
                        localStorage.setItem('rhadzCalSettings', JSON.stringify(data.settings));
                        Object.assign(settings, data.settings);
                    }
                    if (data.notes) localStorage.setItem('rhadzCalNotes', JSON.stringify(data.notes));
                    if (data.themeIndex !== undefined) localStorage.setItem('rhadzThemeIndex', data.themeIndex);

                    alert('Data berhasil dipulihkan! Halaman akan dimuat ulang.');
                    window.location.reload();
                } catch (err) {
                    alert('File backup tidak valid: ' + err.message);
                    console.error(err);
                } finally {
                    input.value = ''; // Reset agar bisa pilih file yang sama lagi
                }
            };
            reader.onerror = function () {
                alert('Gagal membaca file!');
            };
            reader.readAsText(file);
        }

        function getNoteForDate(d, m, y) {
            const key = `${y}-${m}-${d}`;
            const notes = getStoredNotes();
            // Return array of notes, or empty array
            return notes[key] || [];
        }

        function getHijriDate(date) {
            // Normalisasi tanggal target ke 00:00:00
            const targetDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            targetDate.setHours(0, 0, 0, 0);

            // --- 1. COBA CARI DI HARDCODE (ANCHOR) ---
            let bestAnchor = null;
            for (let i = 0; i < hijriAnchors.length; i++) {
                const a = hijriAnchors[i];
                const anchorDate = new Date(a.y, a.m, a.d);
                anchorDate.setHours(0, 0, 0, 0);

                if (targetDate.getTime() >= anchorDate.getTime()) {
                    bestAnchor = { ...a, objDate: anchorDate };
                } else {
                    break; // Karena data urut, stop jika sudah lewat
                }
            }

            // Jika ketemu anchor dan selisih harinya masih wajar (kurang dari 30 hari)
            if (bestAnchor) {
                const diffTime = targetDate.getTime() - bestAnchor.objDate.getTime();
                const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));

                if (diffDays < 30) {
                    // RETURN HASIL HARDCODE (isHardcoded = true)
                    return {
                        day: 1 + diffDays,
                        month: bestAnchor.hM,
                        year: bestAnchor.hY,
                        isHardcoded: true
                    };
                }
            }

            // --- 2. JIKA GAGAL/TIDAK ADA DI HARDCODE, PAKAI RUMUS MATEMATIKA ---
            let julian = Math.floor((date.getTime() / 86400000) + 2440587.5);
            let l = julian - 1948440 + 10632;
            let n = Math.floor((l - 1) / 10631);
            l = l - 10631 * n + 354;
            let j = (Math.floor((10985 - l) / 5316)) * (Math.floor((50 * l) / 17719)) + (Math.floor(l / 5670)) * (Math.floor((43 * l) / 15238));
            l = l - (Math.floor((30 - j) / 15)) * (Math.floor((17719 * j) / 50)) - (Math.floor(j / 16)) * (Math.floor((15238 * j) / 43)) + 29;
            let m = Math.floor((24 * l) / 709);
            let d = l - Math.floor((709 * m) / 24);
            let y = 30 * n + j - 30;

            // Koreksi manual rumus (+1 hari biasanya biar pas)
            d += 1;

            // PENGAMAN: Jangan sampai ada tanggal 31/32 Hijriah
            if (d > 30) {
                d = 1;
                m += 1; // Pindah bulan
            }
            if (m > 12) { // Reset tahun jika lewat Dzulhijjah
                m = 1;
                y += 1;
            }

            // RETURN HASIL RUMUS (isHardcoded = false)
            return {
                day: d,
                month: m - 1,
                year: y,
                isHardcoded: false
            };
        }

        function toggleNotesView(fromHistory = false) {
            isNotesView = !isNotesView;
            const calendarContainer = document.getElementById('calendarViewContainer');
            const notesContainer = document.getElementById('notesViewContainer');
            const calHeader = document.getElementById('calendarHeaderCenter');
            const notesHeader = document.getElementById('notesHeaderCenter');

            const footerLeft = document.getElementById('footerLeftBtn');
            const footerRight = document.getElementById('footerRightBtn');

            if (isNotesView) {
                calendarContainer.classList.add('hidden');
                notesContainer.classList.add('active');
                calHeader.classList.add('hidden');
                notesHeader.classList.remove('hidden');
                footerLeft.innerHTML = '<i class="fas fa-home text-white text-sm"></i>';
                footerRight.innerHTML = '<i class="fas fa-plus text-white text-sm"></i>';
                currentNoteDate = new Date();
                renderNotesList();

                if (!fromHistory && location.hash !== '#notes') {
                    history.pushState({ view: 'notes' }, '', '#notes');
                }
            } else {
                calendarContainer.classList.remove('hidden');
                notesContainer.classList.remove('active');
                calHeader.classList.remove('hidden');
                notesHeader.classList.add('hidden');
                footerLeft.innerHTML = '<i class="fas fa-book text-white text-sm"></i>';
                footerRight.innerHTML = '<i class="fas fa-search text-white text-sm"></i>';

                if (!fromHistory && location.hash === '#notes') {
                    history.back();
                } else if (!fromHistory && (location.hash === '' || location.hash === '#calendar')) {
                    // Do nothing, already at calendar
                }
            }
        }

        function handleFooterRightAction() {
            if (isNotesView) {
                openCreateNoteModal();
            } else {
                openDateSearch();
            }
        }

        function switchNoteTab(mode, tabElement) {
            currentNoteMode = mode;
            document.querySelectorAll('.notes-tab').forEach(t => t.classList.remove('active'));
            tabElement.classList.add('active');
            currentNoteDate = new Date();
            renderNotesList();
        }

        function navNotes(dir) {
            if (currentNoteMode === 'weekly') {
                currentNoteDate.setDate(currentNoteDate.getDate() + (dir * 7));
            } else if (currentNoteMode === 'monthly') {
                currentNoteDate.setMonth(currentNoteDate.getMonth() + dir);
            } else if (currentNoteMode === 'yearly') {
                currentNoteDate.setFullYear(currentNoteDate.getFullYear() + dir);
            }
            renderNotesList();
        }

        function renderNotesList() {
            const container = document.getElementById('notesListContainer');
            const label = document.getElementById('notesNavLabel');
            container.innerHTML = '';

            let startD, endD, labelText;
            const now = new Date();
            const storedNotes = getStoredNotes();
            let notesFound = [];

            if (currentNoteMode === 'weekly') {
                const day = currentNoteDate.getDay();
                const startOfWeek = new Date(currentNoteDate);
                startOfWeek.setDate(currentNoteDate.getDate() - currentNoteDate.getDay());
                const endOfWeek = new Date(startOfWeek);
                endOfWeek.setDate(startOfWeek.getDate() + 6);
                const currentWeekStart = new Date(now);
                currentWeekStart.setDate(now.getDate() - now.getDay());
                const timeDiff = startOfWeek.getTime() - currentWeekStart.getTime();
                const dayDiff = timeDiff / (1000 * 3600 * 24);
                if (Math.abs(dayDiff) < 1) labelText = "MINGGU INI";
                else if (dayDiff > 0 && dayDiff <= 7) labelText = "MINGGU DEPAN";
                else if (dayDiff < 0 && dayDiff >= -7) labelText = "MINGGU LALU";
                else labelText = `${startOfWeek.getDate()}/${startOfWeek.getMonth() + 1} - ${endOfWeek.getDate()}/${endOfWeek.getMonth() + 1}`;
                startD = startOfWeek; endD = endOfWeek;
            } else if (currentNoteMode === 'monthly') {
                labelText = `${monthNames[currentNoteDate.getMonth()]} ${currentNoteDate.getFullYear()}`;
                startD = new Date(currentNoteDate.getFullYear(), currentNoteDate.getMonth(), 1);
                endD = new Date(currentNoteDate.getFullYear(), currentNoteDate.getMonth() + 1, 0);
            } else {
                labelText = `TAHUN ${currentNoteDate.getFullYear()}`;
                startD = new Date(currentNoteDate.getFullYear(), 0, 1);
                endD = new Date(currentNoteDate.getFullYear(), 11, 31);
            }

            label.textContent = labelText;
            Object.keys(storedNotes).forEach(dateKey => {
                const [y, m, d] = dateKey.split('-').map(Number);
                const noteDate = new Date(y, m, d);
                const checkTime = noteDate.getTime();
                const startTime = new Date(startD.getFullYear(), startD.getMonth(), startD.getDate()).getTime();
                const endTime = new Date(endD.getFullYear(), endD.getMonth(), endD.getDate()).getTime();
                if (checkTime >= startTime && checkTime <= endTime) {
                    // IMPORTANT: storedNotes[dateKey] is now ARRAY of OBJECTS
                    notesFound.push({ date: noteDate, items: storedNotes[dateKey], key: dateKey });
                }
            });

            notesFound.sort((a, b) => a.date - b.date);
            if (notesFound.length === 0) {
                container.innerHTML = `
                <div class="flex flex-col items-center justify-center h-48 opacity-50">
                    <i class="fas fa-clipboard-list text-4xl mb-3 text-slate-400"></i>
                    <p class="text-sm font-medium text-slate-500">Tidak ada catatan</p>
                </div>
            `;
                return;
            }

            // Group all notes by category first, then sort by time within each category
            const allNotes = [];
            notesFound.forEach(item => {
                item.items.forEach(note => {
                    allNotes.push({
                        ...note,
                        dateKey: item.key,
                        date: item.date,
                        dateStr: `${item.date.getDate()} ${monthNames[item.date.getMonth()]} ${item.date.getFullYear()}`,
                        dayName: dayNames[item.date.getDay()]
                    });
                });
            });

            // Group by category
            const grouped = {
                penting: [],
                kerja: [],
                pribadi: [],
                ide: []
            };

            allNotes.forEach(note => {
                const cat = note.category || 'pribadi';
                if (grouped[cat]) grouped[cat].push(note);
            });

            // Sort each group by Date first, then Time (earliest first, no-time last)
            Object.keys(grouped).forEach(cat => {
                grouped[cat].sort((a, b) => {
                    // 1. Sort by Date
                    if (a.date.getTime() !== b.date.getTime()) {
                        return a.date - b.date;
                    }
                    // 2. Sort by Time
                    if (a.time && !b.time) return -1;
                    if (!a.time && b.time) return 1;
                    if (a.time && b.time) return a.time.localeCompare(b.time);
                    return 0;
                });
            });

            // Render by category
            const categoryConfig = {
                penting: { label: 'Penting', icon: 'fa-exclamation-circle', color: 'red', borderColor: 'border-red-400', bgColor: 'bg-red-50', textColor: 'text-red-600' },
                kerja: { label: 'Kerja', icon: 'fa-briefcase', color: 'blue', borderColor: 'border-blue-400', bgColor: 'bg-blue-50', textColor: 'text-blue-600' },
                pribadi: { label: 'Pribadi', icon: 'fa-sticky-note', color: 'emerald', borderColor: 'border-emerald-400', bgColor: 'bg-emerald-50', textColor: 'text-emerald-600' },
                ide: { label: 'Ide', icon: 'fa-lightbulb', color: 'amber', borderColor: 'border-amber-400', bgColor: 'bg-amber-50', textColor: 'text-amber-600' }
            };

            ['penting', 'kerja', 'pribadi', 'ide'].forEach(cat => {
                if (grouped[cat].length === 0) return;

                const config = categoryConfig[cat];
                const categoryHeader = document.createElement('div');
                categoryHeader.className = `mb-3 mt-4 first:mt-0`;
                categoryHeader.innerHTML = `
                    <div class="flex items-center gap-2 mb-2">
                        <i class="fas ${config.icon} ${config.textColor}"></i>
                        <span class="text-xs font-bold ${config.textColor} uppercase tracking-wider">${config.label}</span>
                        <span class="text-[0.6rem] font-bold bg-slate-200 text-slate-600 px-2 py-0.5 rounded-full">${grouped[cat].length}</span>
                    </div>
                `;
                container.appendChild(categoryHeader);

                grouped[cat].forEach(note => {
                    const el = document.createElement('div');
                    el.className = `bg-white p-3 rounded-xl shadow-sm border-l-4 ${config.borderColor} mb-2 hover:bg-slate-50 transition`;

                    const isDone = note.isCompleted;
                    const timeBadge = note.time ? `<span class="text-[0.6rem] font-bold bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded"><i class="far fa-clock mr-1"></i>${note.time}</span>` : '';

                    el.innerHTML = `
                        <div class="flex items-start gap-2">
                            <div class="mt-0.5 cursor-pointer" onclick="event.stopPropagation(); toggleNoteStatusInList('${note.dateKey}', '${note.id}')">
                                <i class="fas ${isDone ? 'fa-check-circle text-emerald-500' : 'fa-circle text-slate-300'} text-base"></i>
                            </div>
                            <div class="flex-1 ${isDone ? 'opacity-50 line-through decoration-slate-400' : ''}">
                                <p class="text-sm font-medium text-slate-700 leading-snug mb-1">${note.text}</p>
                                <div class="flex items-center gap-2 text-[0.6rem] text-slate-400">
                                    <span>${note.dayName}, ${note.dateStr}</span>
                                    ${timeBadge}
                                </div>
                            </div>
                            <button onclick="event.stopPropagation(); deleteNoteFromList('${note.dateKey}', '${note.id}')" class="text-slate-300 hover:text-red-500 transition px-2">
                                <i class="fas fa-trash-alt text-sm"></i>
                            </button>
                        </div>
                    `;

                    el.setAttribute('onclick', `openEditNoteModal('${note.dateKey}', '${note.id}')`);

                    container.appendChild(el);
                });
            });
        }

        // Helper functions for Catatanku
        function toggleNoteStatusInList(dateKey, noteId) {
            toggleNoteStatus(dateKey, noteId);
            renderNotesList(); // Fix: use renderNotesList instead of updateNotesView
        }

        function deleteNoteFromList(dateKey, noteId) {
            if (confirm('Apakah Anda yakin ingin menghapus catatan ini?')) {
                deleteNote(dateKey, noteId);
                renderNotesList(); // Fix: use renderNotesList instead of updateNotesView
            }
        }

        function openCreateNoteModal() {
            const overlay = document.getElementById('selectorModal');
            const body = document.getElementById('modalBody');
            const title = document.getElementById('modalTitle');

            title.classList.remove('hidden'); title.textContent = "BUAT CATATAN BARU";
            body.className = "w-full";
            const today = new Date();
            const curD = today.getDate();
            const curM = today.getMonth();
            const curY = today.getFullYear();

            openModal('pos-center');

            body.innerHTML = `
            <div class="mb-4">
                <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2 text-center">Pilih Tanggal</p>
                <div class="flex gap-2 h-32 overflow-hidden relative mask-linear">
                    <div class="flex-1 w-full flex flex-col items-center overflow-x-hidden overflow-y-auto snap-y snap-mandatory scrollbar-none text-center bg-slate-50 rounded-lg" id="scrollDay"></div>
                    <div class="flex-1 w-full flex flex-col items-center overflow-x-hidden overflow-y-auto snap-y snap-mandatory scrollbar-none text-center bg-slate-50 rounded-lg" id="scrollMonth"></div>
                    <div class="flex-1 w-full flex flex-col items-center overflow-x-hidden overflow-y-auto snap-y snap-mandatory scrollbar-none text-center bg-slate-50 rounded-lg" id="scrollYear"></div>
                    <div class="absolute top-1/2 left-0 right-0 h-8 -mt-4 border-t border-b border-slate-300 pointer-events-none bg-slate-900/5"></div>
                </div>
            </div>

            <div class="flex gap-3 mb-4">
                <div class="flex-1">
                    <p class="text-[0.6rem] font-black text-slate-400 uppercase tracking-widest mb-1 ml-1">Kategori</p>
                    <select id="newNoteCategoryList" class="premium-select text-center font-bold" style="background:#f8fafc; border-color:#e2e8f0; height: 48px;" onchange="this.style.color = {pribadi:'#10b981', kerja:'#3b82f6', penting:'#ef4444', ide:'#f59e0b'}[this.value]">
                        <option value="pribadi" selected class="text-emerald-500 font-bold">Pribadi</option>
                        <option value="kerja" class="text-blue-500 font-bold">Kerja</option>
                        <option value="penting" class="text-red-500 font-bold">Penting</option>
                        <option value="ide" class="text-amber-500 font-bold">Ide</option>
                    </select>
                </div>
                <div class="flex-1">
                    <p class="text-[0.6rem] font-black text-slate-400 uppercase tracking-widest mb-1 ml-1">Waktu</p>
                    <input type="time" id="newNoteTimeList" class="premium-select text-center font-bold" style="background:#f8fafc; border-color:#e2e8f0; height: 48px;">
                </div>
            </div>

            <textarea id="newNoteInput" class="w-full p-4 rounded-xl border border-slate-200 text-sm focus:outline-none focus:border-blue-500 transition h-32 resize-none bg-white mb-4 shadow-inner" placeholder="Tulis catatanmu di sini..."></textarea>
            <button onclick="confirmCreateNote()" class="w-full bg-slate-900 text-white p-3 rounded-xl font-bold text-xs tracking-wider shadow-lg hover:bg-slate-800 transition mb-6">SIMPAN CATATAN</button>
        `;

            const dContainer = document.getElementById('scrollDay');
            const mContainer = document.getElementById('scrollMonth');
            const yContainer = document.getElementById('scrollYear');
            const createSpacer = () => { const s = document.createElement('div'); s.style.minHeight = "48px"; s.style.width = "100%"; return s; };

            const initInfiniteScroll = (container, items, initialIndex) => {
                const itemHeight = 36;
                const renderSet = (offsetVal = 0) => {
                    items.forEach((item, idx) => {
                        const realVal = idx;
                        const el = document.createElement('div');
                        el.className = `w-full py-2 text-sm font-bold snap-center cursor-pointer flex-shrink-0 transition-all duration-150`;
                        el.textContent = item;
                        el.dataset.val = realVal;
                        if (realVal === initialIndex && offsetVal === 1) {
                            el.classList.add('text-blue-600', 'scale-110');
                            el.classList.remove('text-slate-400');
                        } else {
                            el.classList.add('text-slate-400');
                        }
                        el.onclick = function () { this.scrollIntoView({ behavior: 'smooth', block: 'center' }); };
                        container.appendChild(el);
                    });
                };
                container.innerHTML = '';
                container.appendChild(createSpacer());
                renderSet(0); renderSet(1); renderSet(2);
                container.appendChild(createSpacer());
                setTimeout(() => {
                    const allItems = container.querySelectorAll(`div[data-val="${initialIndex}"]`);
                    if (allItems.length >= 2) allItems[1].scrollIntoView({ block: 'center' });
                }, 50);
                container.onscroll = () => {
                    const totalHeight = container.scrollHeight;
                    const viewHeight = container.clientHeight;
                    const scrollTop = container.scrollTop;
                    if (scrollTop < 50) {
                        const middleElement = container.querySelectorAll(`div[data-val="0"]`)[1];
                        if (middleElement) middleElement.scrollIntoView({ block: 'start' });
                    } else if (scrollTop > totalHeight - viewHeight - 50) {
                        const middleElement = container.querySelectorAll(`div[data-val="${items.length - 1}"]`)[1];
                        if (middleElement) middleElement.scrollIntoView({ block: 'end' });
                    }
                    const center = scrollTop + viewHeight / 2;
                    Array.from(container.children).forEach(child => {
                        if (!child.dataset.val) return;
                        const childCenter = child.offsetTop + child.offsetHeight / 2;
                        if (Math.abs(center - childCenter) < 20) {
                            child.classList.add('text-blue-600', 'scale-110');
                            child.classList.remove('text-slate-400');
                        } else {
                            child.classList.remove('text-blue-600', 'scale-110');
                            child.classList.add('text-slate-400');
                        }
                    });
                };
            };

            const daysArr = Array.from({ length: 31 }, (_, i) => i + 1);
            initInfiniteScroll(dContainer, daysArr, curD - 1);
            const monthsShort = monthNames.map(m => m.substring(0, 3));
            initInfiniteScroll(mContainer, monthsShort, curM);
            yContainer.appendChild(createSpacer());
            for (let i = curY - 50; i <= curY + 50; i++) {
                const el = document.createElement('div');
                el.className = `w-full py-2 text-sm font-bold snap-center cursor-pointer flex-shrink-0 ${i === curY ? 'text-blue-600 scale-110' : 'text-slate-400'}`;
                el.textContent = i;
                el.dataset.val = i;
                el.onclick = function () { this.scrollIntoView({ behavior: 'smooth', block: 'center' }); };
                yContainer.appendChild(el);
            }
            yContainer.appendChild(createSpacer());
            setTimeout(() => {
                const activeY = yContainer.querySelector('.text-blue-600');
                if (activeY) activeY.scrollIntoView({ block: 'center' });
                yContainer.addEventListener('scroll', () => {
                    const center = yContainer.scrollTop + yContainer.offsetHeight / 2;
                    Array.from(yContainer.children).forEach(child => {
                        if (!child.dataset.val) return;
                        const childCenter = child.offsetTop + child.offsetHeight / 2;
                        if (Math.abs(center - childCenter) < 20) {
                            child.classList.add('text-blue-600', 'scale-110');
                            child.classList.remove('text-slate-400');
                        } else {
                            child.classList.remove('text-blue-600', 'scale-110');
                            child.classList.add('text-slate-400');
                        }
                    });
                });
            }, 100);

            openModal();
        }

        function confirmCreateNote() {
            const getVal = (id) => {
                const c = document.getElementById(id);
                const center = c.scrollTop + c.offsetHeight / 2;
                let val = null; let minDiff = Infinity;
                Array.from(c.children).forEach(child => {
                    if (child.dataset.val === undefined) return;
                    const childCenter = child.offsetTop + child.offsetHeight / 2;
                    const diff = Math.abs(center - childCenter);
                    if (diff < minDiff) { minDiff = diff; val = child.dataset.val; }
                });
                return parseInt(val);
            };
            const dIndex = getVal('scrollDay');
            const m = getVal('scrollMonth');
            const y = getVal('scrollYear');
            const d = dIndex + 1;
            const text = document.getElementById('newNoteInput').value.trim();
            const category = document.getElementById('newNoteCategoryList').value;
            const time = document.getElementById('newNoteTimeList').value;

            if (!text) { alert('Tulis catatan dulu!'); return; }

            const dateKey = `${y}-${m}-${d}`;
            addNote(dateKey, text, category, time);
            closeModal();
            renderNotesList(); // Fix: replaced updateNotesView with renderNotesList
        }

        function openEditNoteModal(dateKey, noteId) {
            const notes = getStoredNotes();
            const noteList = notes[dateKey];
            if (!noteList) return;
            const note = noteList.find(n => n.id == noteId);
            if (!note) return;

            const body = document.getElementById('modalBody');
            const title = document.getElementById('modalTitle');

            title.classList.remove('hidden'); title.textContent = "EDIT CATATAN";
            body.className = "w-full";

            openModal('pos-center');

            body.innerHTML = `
            <div class="mb-4">
                <p class="text-[0.6rem] font-black text-slate-400 uppercase tracking-widest mb-1 ml-1 text-center">Tanggal: ${dateKey}</p>
            </div>

            <div class="flex gap-3 mb-4">
                <div class="flex-1">
                    <p class="text-[0.6rem] font-black text-slate-400 uppercase tracking-widest mb-1 ml-1">Kategori</p>
                    <select id="editNoteCategory" class="premium-select text-center font-bold" style="background:#f8fafc; border-color:#e2e8f0; height: 48px;">
                        <option value="pribadi" ${note.category === 'pribadi' ? 'selected' : ''}>Pribadi</option>
                        <option value="kerja" ${note.category === 'kerja' ? 'selected' : ''}>Kerja</option>
                        <option value="penting" ${note.category === 'penting' ? 'selected' : ''}>Penting</option>
                        <option value="ide" ${note.category === 'ide' ? 'selected' : ''}>Ide</option>
                    </select>
                </div>
                <div class="flex-1">
                    <p class="text-[0.6rem] font-black text-slate-400 uppercase tracking-widest mb-1 ml-1">Waktu</p>
                    <input type="time" id="editNoteTime" value="${note.time || ''}" class="premium-select text-center font-bold" style="background:#f8fafc; border-color:#e2e8f0; height: 48px;">
                </div>
            </div>

            <textarea id="editNoteInput" class="w-full p-4 rounded-xl border border-slate-200 text-sm focus:outline-none focus:border-blue-500 transition h-32 resize-none bg-white mb-4 shadow-inner" placeholder="Tulis catatanmu di sini...">${note.text}</textarea>
            <button onclick="confirmEditNote('${dateKey}', '${noteId}')" class="w-full bg-slate-900 text-white p-3 rounded-xl font-bold text-xs tracking-wider shadow-lg hover:bg-slate-800 transition mb-6">SIMPAN PERUBAHAN</button>
            `;
        }

        function confirmEditNote(dateKey, noteId) {
            const text = document.getElementById('editNoteInput').value.trim();
            const category = document.getElementById('editNoteCategory').value;
            const time = document.getElementById('editNoteTime').value;

            if (!text) { alert('Tulis catatan dulu!'); return; }

            editNote(dateKey, noteId, text, category, time);

            // Jika di Catatanku, langsung tutup. Jika di Detail Hari, refresh detailnya.
            if (isNotesView) {
                closeModal();
            } else {
                closeModal(true); // Tutup edit modal tanpa membuang history #modal
                if (lastDetailArgs) showDetail(...lastDetailArgs);
            }
        }

        function getHolidayName(d, m, y) {
            if (holidaysData[y] && holidaysData[y][m] && holidaysData[y][m][d]) return holidaysData[y][m][d];
            return null;
        }
        function getCutiBersamaName(d, m, y) {
            if (cutiBersamaData[y] && cutiBersamaData[y][m] && cutiBersamaData[y][m][d]) return cutiBersamaData[y][m][d];
            return null;
        }
        function getObservanceName(d, m) {
            if (settings.showObservances && nationalObservances[m] && nationalObservances[m][d]) return nationalObservances[m][d];
            return null;
        }
        function getBirthday(d, m) {
            if (!settings.showFamily) return null;
            return familyBirthdays.find(b => b.day === d && b.month === m);
        }
        function isAnniversary(d, m) {
            if (!settings.showFamily) return null;
            return weddingAnniversary.day === d && weddingAnniversary.month === m;
        }

        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const now = new Date();
            const isCurrentMonthYear = (now.getFullYear() === year && now.getMonth() === month);
            const todayDayNum = now.getDate();
            document.getElementById('monthLabelMobile').textContent = monthNames[month];
            document.getElementById('yearLabelMobile').textContent = year;
            document.getElementById('desktopMonthYear').textContent = `${monthNames[month]} ${year}`;
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDay = new Date(year, month, 1).getDay();
            const startH = getHijriDate(new Date(year, month, 1));
            const endH = getHijriDate(new Date(year, month, daysInMonth));

            // Cek jika perpindahan tahun hijriah terjadi di bulan ini
            let hijriYearStr = startH.year;
            if (startH.year !== endH.year) {
                hijriYearStr = `${startH.year} / ${endH.year}`;
            }

            const hijriStr = `${hijriMonths[startH.month]} - ${hijriMonths[endH.month]}`;

            document.getElementById('hijriRangeMobile').textContent = hijriStr;
            // Sekarang Tahunnya Dinamis mengambil dari startH.year
            document.getElementById('desktopHijri').textContent = `${hijriStr} ${hijriYearStr}H`;
            const d_hijri = settings.showHijri ? 'block' : 'none';
            document.getElementById('hijriRangeMobile').style.display = d_hijri;
            document.getElementById('desktopHijri').style.display = d_hijri;
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            dayShortNames.forEach(d => {
                const el = document.createElement('div');
                el.className = 'day-label'; el.textContent = d; grid.appendChild(el);
            });

            // DYNAMIC ROWS: Hitung berapa cell yang benar-benar dibutuhkan (kelipatan 7)
            const requiredCells = firstDay + daysInMonth;
            const totalCells = Math.ceil(requiredCells / 7) * 7;

            const prevMonthLastDate = new Date(year, month, 0).getDate();
            for (let i = 0; i < totalCells; i++) {
                const cell = document.createElement('div');
                let displayDate, targetMonth, targetYear, isOtherMonth = false;
                if (i < firstDay) {
                    displayDate = prevMonthLastDate - (firstDay - i - 1);
                    targetMonth = month - 1; targetYear = year; isOtherMonth = true;
                } else if (i < firstDay + daysInMonth) {
                    displayDate = i - firstDay + 1; targetMonth = month; targetYear = year;
                } else {
                    displayDate = i - (firstDay + daysInMonth) + 1; targetMonth = month + 1; targetYear = year; isOtherMonth = true;
                }
                const dateObj = new Date(targetYear, targetMonth, displayDate);
                const actualDay = dateObj.getDate(); const actualMonth = dateObj.getMonth(); const actualYear = dateObj.getFullYear();
                if (isOtherMonth) {
                    cell.className = 'day-cell other-month'; cell.innerHTML = `<span class="date-wrapper">${actualDay}</span>`;
                } else {
                    const isToday = isCurrentMonthYear && actualDay === todayDayNum;

                    // Ambil data Hijriah (Pasti ada isi, entah dari hardcode atau rumus)
                    const h = getHijriDate(dateObj);

                    const dayOfWeek = dateObj.getDay();
                    const isSunday = dayOfWeek === 0; const isFriday = dayOfWeek === 5;
                    const holidayName = getHolidayName(actualDay, actualMonth, actualYear);
                    const isHoliday = !!holidayName;
                    const cutiName = getCutiBersamaName(actualDay, actualMonth, actualYear);
                    const observanceName = getObservanceName(actualDay, actualMonth);
                    const birthdayData = getBirthday(actualDay, actualMonth);
                    const anniversaryData = isAnniversary(actualDay, actualMonth);
                    const noteList = getNoteForDate(actualDay, actualMonth, actualYear);
                    const hasNote = noteList && noteList.length > 0;

                    // Pasaran Logic
                    const refDate = new Date(2026, 1, 1);
                    const refPasaranIndex = 3;
                    const diff = Math.floor((dateObj - refDate) / 86400000);
                    let pasaranIdx = (refPasaranIndex + (diff % 5)) % 5;
                    if (pasaranIdx < 0) pasaranIdx += 5;

                    // TAMPILAN
                    const pasaranContent = settings.showPasaran ? `<span class="pasaran-text">${pasaranArr[pasaranIdx]}</span>` : '';

                    let hijriContent = '';
                    // Variabel untuk modal
                    let hDayModal = h.day;
                    let hMonthModal = hijriMonths[h.month];
                    let hYearModal = h.year;
                    // Simpan status apakah ini hardcode atau bukan
                    let isHardcodedStatus = h.isHardcoded;

                    if (settings.showHijri) {
                        if (h.day === 1) {
                            let badgeBg = 'bg-slate-600';
                            if (isSunday || isHoliday) badgeBg = 'bg-red-500';
                            else if (isFriday) badgeBg = 'bg-emerald-500';
                            hijriContent = `<div class="hijri-badge ${badgeBg}">${h.day}</div>`;
                        } else {
                            hijriContent = `<span class="hijri-text">${h.day}</span>`;
                        }
                    }

                    const cutiDotHTML = !!cutiName ? `<div class="cuti-dot"></div>` : '';
                    const obsDotHTML = !!observanceName ? `<div class="obs-dot"></div>` : '';
                    const noteDotHTML = hasNote ? `<div class="note-indicator"></div>` : '';

                    let cellClass = `day-cell ${isToday ? 'today' : ''}`;
                    if (isToday && highlightTriggered) cellClass += ' today-jump-animation';
                    if (anniversaryData) cellClass += ' anniversary';
                    else if (birthdayData) cellClass += ' birthday';
                    else if (isSunday || isHoliday) cellClass += ' sunday';
                    else if (isFriday) cellClass += ' friday';

                    cell.className = cellClass;

                    // PERUBAHAN DI SINI: 
                    // ${noteDotHTML} saya pindahkan MASUK ke dalam <span class="date-wrapper">
                    // Agar posisinya terikat dengan angka tanggal, bukan dengan kotak kartu
                    cell.innerHTML = `
                    <span class="date-wrapper">
                        ${actualDay}
                        ${cutiDotHTML}
                        ${obsDotHTML}
                        ${noteDotHTML} 
                    </span>
                    
                    <div class="cell-bottom-row">
                        ${pasaranContent}
                        ${hijriContent}
                    </div>
                `;

                    // UPDATE ONCLICK: Tambahkan parameter isHardcodedStatus di paling belakang
                    cell.onclick = () => showDetail(actualDay, actualMonth, actualYear, dayNames[dayOfWeek], pasaranArr[pasaranIdx], hDayModal, hMonthModal, hYearModal, holidayName, cutiName, observanceName, isSunday, birthdayData, anniversaryData, isHardcodedStatus);
                }
                grid.appendChild(cell);
            }
            renderEventsList(month, year);
            if (highlightTriggered) setTimeout(() => { highlightTriggered = false; }, 2000);
        }

        function renderEventsList(month, year) {
            let htmlContent = '';
            const realToday = new Date();
            const tDay = realToday.getDate(); const tMonth = realToday.getMonth(); const tYear = realToday.getFullYear();
            if (settings.showFamily && weddingAnniversary.month === month) {
                const annAge = year - weddingAnniversary.year;
                if (annAge > 0) {
                    const isToday = (weddingAnniversary.day === tDay && month === tMonth);
                    htmlContent += `<div class="anniversary-item ${isToday ? 'highlight-today' : ''} flex justify-between items-center cursor-pointer hover:scale-[1.02] transition">
                    <div class="flex flex-col"><span class="text-[0.7rem] font-bold text-pink-800">${weddingAnniversary.day} ${monthNames[month]}</span><span class="text-[0.6rem] text-pink-600 font-semibold">Anniversary Pernikahan </span></div><span class="text-[0.65rem] font-bold text-pink-700 bg-pink-100 px-2 py-1 rounded-full">Ke-${annAge}</span></div>`;
                }
            }
            if (settings.showFamily) {
                const monthBirthdays = familyBirthdays.filter(b => b.month === month).sort((a, b) => a.day - b.day);
                monthBirthdays.forEach(b => {
                    const age = year - b.year; const isToday = (b.day === tDay && month === tMonth);
                    htmlContent += `<div class="birthday-item ${isToday ? 'highlight-today' : ''} flex justify-between items-center cursor-pointer hover:scale-[1.02] transition">
                    <div class="flex flex-col"><span class="text-[0.7rem] font-bold text-amber-800">${b.day} ${monthNames[month]}</span><span class="text-[0.6rem] text-amber-600 font-semibold truncate w-32">Ulang Tahun ${b.name}</span></div><span class="text-[0.65rem] font-bold text-amber-700 bg-amber-100 px-2 py-1 rounded-full">Ke-${age}</span></div>`;
                });
            }
            let mergedEvents = [];
            const storedNotes = getStoredNotes();
            Object.keys(storedNotes).forEach(dateKey => {
                const [nY, nM, nD] = dateKey.split('-').map(Number);
                if (nY === year && nM === month) {
                    const noteArr = storedNotes[dateKey];
                    if (Array.isArray(noteArr) && noteArr.length > 0) {
                        // Push GROUP object instead of single text
                        mergedEvents.push({ day: nD, type: 'note-group', items: noteArr });
                    }
                }
            });
            if (holidaysData[year] && holidaysData[year][month]) {
                Object.keys(holidaysData[year][month]).forEach(d => mergedEvents.push({ day: parseInt(d), name: holidaysData[year][month][d], type: 'holiday' }));
            }
            if (cutiBersamaData[year] && cutiBersamaData[year][month]) {
                Object.keys(cutiBersamaData[year][month]).forEach(d => mergedEvents.push({ day: parseInt(d), name: cutiBersamaData[year][month][d], type: 'cuti' }));
            }
            if (settings.showObservances && nationalObservances[month]) {
                Object.keys(nationalObservances[month]).forEach(d => mergedEvents.push({ day: parseInt(d), name: nationalObservances[month][d], type: 'observance' }));
            }
            mergedEvents.sort((a, b) => a.day - b.day);
            mergedEvents.forEach(evt => {
                const isToday = (evt.day === tDay && month === tMonth && year === tYear);

                if (evt.type === 'note-group') {
                    // --- RENDER GROUP NOTE ---
                    const items = evt.items;
                    if (items.length === 1) {
                        // SINGLE NOTE
                        const n = items[0];
                        let iconClass = 'fa-sticky-note text-emerald-500';
                        if (n.category === 'kerja') iconClass = 'fa-briefcase text-blue-500';
                        else if (n.category === 'penting') iconClass = 'fa-exclamation-circle text-red-500';
                        else if (n.category === 'ide') iconClass = 'fa-lightbulb text-amber-500';

                        const timeBadge = n.time ? `<span class="ml-1 text-[0.55rem] font-bold bg-slate-100 text-slate-500 px-1 rounded">${n.time}</span>` : '';

                        htmlContent += `<div class="note-item ${isToday ? 'highlight-today' : ''} flex justify-between items-center cursor-pointer hover:scale-[1.02] transition" onclick="showDetail(${evt.day}, ${month}, ${year}, '${dayNames[new Date(year, month, evt.day).getDay()]}', '', '', '', '', null, null, null, false, null, null, false)">
                        <span class="text-[0.7rem] font-bold text-slate-800 w-8">${evt.day} ${monthNames[month].substring(0, 3)}</span>
                        <div class="flex-1 flex items-center justify-end gap-1 overflow-hidden">
                             <i class="fas ${iconClass} text-[0.6rem]"></i>
                             <span class="text-[0.65rem] text-emerald-700 font-medium truncate">${n.text}</span>
                             ${timeBadge}
                        </div>
                        </div>`;
                    } else {
                        // MULTIPLE NOTES (Expandable)
                        // SORT by time first
                        items.sort((a, b) => {
                            if (a.time && !b.time) return -1;
                            if (!a.time && b.time) return 1;
                            if (a.time && b.time) return a.time.localeCompare(b.time);
                            return 0;
                        });

                        let subListHTML = '';
                        items.forEach(n => {
                            let iconClass = 'fa-sticky-note text-emerald-500';
                            if (n.category === 'kerja') iconClass = 'fa-briefcase text-blue-500';
                            else if (n.category === 'penting') iconClass = 'fa-exclamation-circle text-red-500';
                            else if (n.category === 'ide') iconClass = 'fa-lightbulb text-amber-500';
                            const timeStr = n.time ? n.time : '--:--';

                            subListHTML += `
                             <div class="flex items-center gap-2 py-1 border-b border-slate-100 last:border-0 pl-2">
                                <span class="text-[0.6rem] font-bold text-slate-400 w-8">${timeStr}</span>
                                <i class="fas ${iconClass} text-[0.6rem] w-3 text-center"></i>
                                <span class="text-[0.65rem] text-slate-600 truncate flex-1">${n.text}</span>
                             </div>`;
                        });

                        htmlContent += `
                        <details class="note-item ${isToday ? 'highlight-today' : ''} group open:bg-emerald-50 transition-all duration-300 overflow-hidden">
                            <summary class="flex justify-between items-center cursor-pointer list-none p-0">
                                <span class="text-[0.7rem] font-bold text-slate-800 w-8">${evt.day} ${monthNames[month].substring(0, 3)}</span>
                                <div class="flex-1 flex items-center justify-end gap-1">
                                    <span class="text-[0.65rem] font-bold bg-emerald-100 text-emerald-600 px-2 py-0.5 rounded-full">${items.length} Catatan</span>
                                    <i class="fas fa-chevron-down text-[0.6rem] text-slate-400 group-open:rotate-180 transition-transform"></i>
                                </div>
                            </summary>
                            <div class="mt-2 pt-2 border-t border-emerald-100 bg-white/50 rounded-lg">
                                ${subListHTML}
                                <div class="text-center mt-1">
                                    <button onclick="showDetail(${evt.day}, ${month}, ${year}, '${dayNames[new Date(year, month, evt.day).getDay()]}', '', '', '', '', null, null, null, false, null, null, false)" class="text-[0.6rem] font-bold text-emerald-600 hover:text-emerald-800 uppercase tracking-wider py-1">Lihat Detail</button>
                                </div>
                            </div>
                        </details>`;
                    }
                } else {
                    // --- RENDER STANDARD EVENT (Holiday, Cuti, Observance) ---
                    let colorClass, itemClass;
                    if (evt.type === 'observance') { colorClass = 'text-blue-600'; itemClass = 'observance-item'; }
                    else { colorClass = 'text-red-600'; itemClass = 'holiday-item'; }

                    htmlContent += `<div class="${itemClass} ${isToday ? 'highlight-today' : ''} flex justify-between items-center cursor-pointer hover:scale-[1.02] transition">
                    <span class="text-[0.7rem] font-bold text-slate-800 w-10">${evt.day} ${monthNames[month].substring(0, 3)}</span><span class="text-[0.65rem] ${colorClass} font-medium text-right w-2/3 leading-tight line-clamp-2">${evt.name}</span></div>`;
                }
            });
            document.getElementById('holidayContainerMobile').innerHTML = htmlContent;
            document.getElementById('holidayContainerDesktop').innerHTML = htmlContent;
            if (!isNotesView) {
                const mobileContainer = document.getElementById('mobileInfoSection');
                if (mobileContainer) {
                    mobileContainer.scrollTop = 0;
                    setTimeout(() => {
                        const todayEvent = document.querySelector('.highlight-today');
                        if (todayEvent) todayEvent.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' });
                    }, 600);
                }
            }
        }

        function goToToday() {
            const now = new Date();
            const isSameMonthYear = (currentDate.getFullYear() === now.getFullYear() && currentDate.getMonth() === now.getMonth());
            highlightTriggered = true;

            // Jika di halaman Catatanku, balik dulu ke Kalender
            if (isNotesView) {
                toggleNotesView();
            }

            if (isSameMonthYear) renderCalendar();
            else {
                const dir = (now.getFullYear() > currentDate.getFullYear() || (now.getFullYear() === now.getFullYear() && now.getMonth() > currentDate.getMonth())) ? 1 : -1;
                const originalTransition = settings.transitionType;
                settings.transitionType = 'zoom';
                changeMonth(dir, now);
                setTimeout(() => { settings.transitionType = originalTransition; }, 1000);
            }
        }

        function updateQuote() {
            const idx = Math.floor(Math.random() * quotes.length);
            const q = `"${quotes[idx]}"`;
            document.getElementById('quoteDisplayMobile').textContent = q;
            document.getElementById('quoteDisplayDesktop').textContent = q;
        }

        function changeMonth(dir, targetDate = null) {
            // --- BAGIAN BARU: Cek Transisi 'None' di Awal ---
            // Jika user memilih "None", kita langsung ubah tanggal dan render ulang.
            // Kita gunakan 'return' agar kode animasi di bawahnya TIDAK dijalankan sama sekali.
            if (settings.transitionType === 'none') {
                if (targetDate) {
                    currentDate = new Date(targetDate);
                } else {
                    // Ubah tanggal ke tanggal 1 bulan berikutnya/sebelumnya
                    currentDate.setDate(1);
                    currentDate.setMonth(currentDate.getMonth() + dir);
                }
                renderCalendar();
                updateQuote();
                return; // <--- INI KUNCINYA: Berhenti di sini, jangan lanjut ke animasi/setTimeout
            }

            // --- BAGIAN LAMA (ANIMASI) ---
            // Kode di bawah ini hanya akan jalan jika transitionType BUKAN 'none'

            if (isAnimating) return;
            isAnimating = true;

            const container = document.getElementById('gridContainer');
            const type = settings.transitionType;

            const applyTransitionOut = () => {
                container.style.opacity = '0';
                switch (type) {
                    case 'slide': container.style.transform = dir > 0 ? 'translateX(-15%)' : 'translateX(15%)'; break;
                    case 'cube': container.style.transformOrigin = dir > 0 ? 'left center' : 'right center'; container.style.transform = dir > 0 ? 'rotateY(-90deg) scale(0.85) translateZ(50px)' : 'rotateY(90deg) scale(0.85) translateZ(50px)'; break;
                    case 'zoom': container.style.transform = 'scale(0.8)'; break;
                    case 'flip': container.style.transform = 'rotateY(180deg)'; break;
                }
            };

            const applyTransitionIn = () => {
                container.style.transition = 'none';
                switch (type) {
                    case 'slide': container.style.transform = dir > 0 ? 'translateX(15%)' : 'translateX(-15%)'; break;
                    case 'cube': container.style.transformOrigin = dir > 0 ? 'right center' : 'left center'; container.style.transform = dir > 0 ? 'rotateY(90deg) scale(0.85) translateZ(50px)' : 'rotateY(-90deg) scale(0.85) translateZ(50px)'; break;
                    case 'zoom': container.style.transform = 'scale(1.2)'; break;
                    case 'flip': container.style.transform = 'rotateY(-180deg)'; break;
                }
            };

            const resetTransition = () => {
                const duration = type === 'cube' || type === 'flip' ? '0.3s' : '0.2s';
                const easing = type === 'cube' ? 'cubic-bezier(0.175, 0.885, 0.32, 1.275)' : 'cubic-bezier(0.4, 0, 0.2, 1)';
                container.style.transition = `transform ${duration} ${easing}, opacity 0.3s`;
                container.style.transform = 'translateX(0) rotateY(0deg) scale(1) translateZ(0)';
                container.style.opacity = '1';
            };

            // Eksekusi Animasi
            applyTransitionOut();

            // setTimeout ini yang bikin lag di versi lama, sekarang hanya jalan kalau ada animasi
            setTimeout(() => {
                if (targetDate) currentDate = new Date(targetDate);
                else { currentDate.setDate(1); currentDate.setMonth(currentDate.getMonth() + dir); }

                renderCalendar();
                updateQuote();
                applyTransitionIn();

                setTimeout(() => {
                    resetTransition();
                    setTimeout(() => isAnimating = false, 500);
                }, 50);
            }, 250);
        }

        function openSettings() {
            const overlay = document.getElementById('selectorModal');
            const body = document.getElementById('modalBody');
            const title = document.getElementById('modalTitle');

            overlay.classList.add('pos-center');
            title.classList.remove('hidden'); title.textContent = "PENGATURAN";
            body.className = "p-4 space-y-4";

            const makeToggle = (label, key) => `<div class="flex justify-between items-center p-2 bg-slate-50 rounded-xl"><span class="font-bold text-sm text-slate-700">${label}</span><input type="checkbox" class="toggle-switch" ${settings[key] ? 'checked' : ''} onchange="toggleSetting('${key}')"></div>`;

            let html = makeToggle('Mode Gelap', 'darkMode') +  // <-- INI BARU
                makeToggle('Hari Pasaran', 'showPasaran') +
                makeToggle('Kalender Hijriah', 'showHijri') +
                makeToggle('Hari Peringatan Nasional', 'showObservances');
            // --- GENERATE TOMBOL WARNA ---
            let themeButtonsHTML = '';
            themes.forEach((t, i) => {
                const isActive = i === currentThemeIndex;
                const activeClass = isActive ? `${t.borderColor} ring-2 ${t.ringColor}` : 'border-transparent';

                // Tombol render
                themeButtonsHTML += `<button id="themeBtn-${i}" onclick="applyTheme(${i})" class="w-10 h-10 rounded-full border-2 ${activeClass} ${t.colorBg} transition hover:scale-110 shadow-sm"></button>`;
            });

            // TAMBAHAN: Backup & Restore UI
            html += `
            <div class="bg-blue-50 border border-blue-100 rounded-xl p-4 mt-4">
                <span class="block font-bold text-sm text-blue-800 mb-2">Cadangkan Data</span>
                <p class="text-xs text-blue-600 mb-3">Simpan atau pulihkan catatanmu agar tidak hilang.</p>
                <div class="flex gap-2">
                    <button onclick="exportData()" class="flex-1 bg-white border border-blue-200 text-blue-700 py-2 rounded-lg font-bold text-xs shadow-sm hover:bg-blue-50 transition"><i class="fas fa-download mr-1"></i> BACKUP</button>
                    <label class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-bold text-xs shadow-sm hover:bg-blue-700 transition text-center cursor-pointer">
                        <i class="fas fa-upload mr-1"></i> RESTORE
                        <input type="file" class="hidden" accept=".json" onchange="importData(this)">
                    </label>
                </div>
            </div>
        `;

            html += `
            <div class="bg-slate-50 rounded-xl p-4">
                <span class="block font-bold text-sm text-slate-700 mb-4 text-center">Pilih Tema Aplikasi</span>
                
                <div class="grid grid-cols-4 gap-y-4 gap-x-2 justify-items-center mb-2">
                    ${themeButtonsHTML}
                </div>
                
                <div class="text-center mt-4 pt-2 border-t border-slate-200">
                    <span class="text-[0.65rem] font-bold text-slate-400 uppercase tracking-widest">Tema Aktif</span>
                    <div class="text-xs font-bold text-slate-700 uppercase tracking-wider mt-1" id="themeNameModal">${themes[currentThemeIndex].name}</div>
                </div>
            </div>`;

            html += `<div class="pt-2"><span class="block font-bold text-[0.65rem] text-slate-400 uppercase tracking-widest mb-2 px-1">Efek Transisi Bulan</span><select class="premium-select" onchange="updateTransition(this.value)"><option value="none" ${settings.transitionType === 'none' ? 'selected' : ''}>None (Instant)</option><option value="slide" ${settings.transitionType === 'slide' ? 'selected' : ''}>Slide (Klasik)</option><option value="cube" ${settings.transitionType === 'cube' ? 'selected' : ''}>Cube Flip (3D)</option><option value="fade" ${settings.transitionType === 'fade' ? 'selected' : ''}>Fade (Lembut)</option><option value="zoom" ${settings.transitionType === 'zoom' ? 'selected' : ''}>Zoom In/Out</option><option value="flip" ${settings.transitionType === 'flip' ? 'selected' : ''}>Flip Card</option></select></div><div class="h-10"></div>`;

            body.innerHTML = html;
            openModal('pos-center');
        }

        function toggleSetting(key) {
            settings[key] = !settings[key];
            saveSettingsToStorage();

            // TAMBAHAN LOGIKA KHUSUS DARK MODE
            if (key === 'darkMode') {
                if (settings.darkMode) {
                    document.body.classList.add('dark-mode');
                } else {
                    document.body.classList.remove('dark-mode');
                }
            }

            syncSettingsUI();
            renderCalendar();
        }
        function createScrollerItem(text, value, isActive) { const item = document.createElement('div'); item.className = `scroller-item ${isActive ? 'active' : ''}`; item.textContent = text; item.dataset.value = value; return item; }

        function setupScrollSnapObserver(containerId) {
            const container = document.getElementById(containerId);
            let scrollTimeout;
            container.onscroll = () => {
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => {
                    const center = container.scrollTop + (container.clientHeight / 2);
                    const items = container.querySelectorAll('.scroller-item');
                    let closest = null; let minDiff = Infinity;
                    items.forEach(item => {
                        const itemCenter = item.offsetTop + (item.offsetHeight / 2);
                        const diff = Math.abs(center - itemCenter);
                        if (diff < minDiff) { minDiff = diff; closest = item; }
                        item.classList.remove('active');
                    });
                    if (closest) closest.classList.add('active');
                }, 50);
            };
        }

        function openMonthSelector() {
            const overlay = document.getElementById('selectorModal');
            const body = document.getElementById('modalBody');
            const title = document.getElementById('modalTitle');

            // 1. Tambahkan class khusus agar modal muncul di atas
            overlay.classList.add('pos-top');

            title.classList.remove('hidden');
            title.textContent = "PILIH BULAN";

            // Menggunakan grid yang sudah kita perbaiki sebelumnya
            body.className = "grid grid-cols-3 gap-3 p-2 pb-4"; // pb dikurangi dikit karena di atas lebih aman

            body.innerHTML = '';
            monthNames.forEach((m, i) => {
                const div = document.createElement('div');
                div.className = `p-3 text-center rounded-xl font-bold text-[0.75rem] cursor-pointer transition active:scale-95 ${currentDate.getMonth() === i ? 'bg-slate-900 text-white shadow-lg' : 'bg-slate-50 text-slate-600 hover:bg-slate-100'}`;
                div.textContent = m;
                div.onclick = () => {
                    currentDate.setMonth(i);
                    renderCalendar();
                    closeModal();
                };
                body.appendChild(div);
            });

            openModal('pos-top');
        }

        function openYearSelector() {
            const overlay = document.getElementById('selectorModal');
            const body = document.getElementById('modalBody');
            const title = document.getElementById('modalTitle');

            overlay.classList.add('pos-top');
            title.classList.remove('hidden');
            title.textContent = "PILIH TAHUN";
            body.className = "w-full";

            const currentYear = currentDate.getFullYear();
            // Tombol juga sudah dinaikkan (mb-8) sesuai request sebelumnya
            body.innerHTML = `<div class="scroller-wrapper"><div class="selection-indicator"></div><div class="scroller-col" id="yearListScroll"></div></div><button onclick="selectHighlightedYear()" class="w-full mt-4 bg-slate-900 text-white p-3 rounded-xl font-bold text-xs tracking-wider mb-4">PILIH TAHUN</button>`;

            const list = document.getElementById('yearListScroll');
            for (let y = currentYear - 100; y <= currentYear + 100; y++) list.appendChild(createScrollerItem(y, y, y === currentYear));

            openModal('pos-top');
            setupScrollSnapObserver('yearListScroll');
            setTimeout(() => { const active = list.querySelector('.active'); if (active) active.scrollIntoView({ block: 'center' }); }, 100);
        }

        function selectHighlightedYear() {
            const activeEl = document.querySelector('#yearListScroll .active');
            if (activeEl) { currentDate.setFullYear(parseInt(activeEl.dataset.value)); renderCalendar(); closeModal(); }
        }

        function openDateSearch() {
            const overlay = document.getElementById('selectorModal');
            const body = document.getElementById('modalBody');
            const title = document.getElementById('modalTitle');
            // REMOVED pos-top agar nempelBAWAH (sesuai request)
            title.classList.remove('hidden'); title.textContent = "CARI TANGGAL";
            body.className = "w-full";
            const curM = currentDate.getMonth(); const curY = currentDate.getFullYear();
            body.innerHTML = `<div class="scroller-wrapper"><div class="selection-indicator"></div><div class="scroller-col" id="monthScroller"></div><div class="scroller-col" id="yearScroller"></div></div><button onclick="jumpToSelectedMonthYear()" class="w-full mt-4 bg-slate-900 text-white p-3 rounded-xl font-bold text-xs tracking-wider mb-8">LIHAT KALENDER</button>`;
            const mList = document.getElementById('monthScroller'); const yList = document.getElementById('yearScroller');
            monthNames.forEach((m, i) => { mList.appendChild(createScrollerItem(m, i, i === curM)); });
            for (let y = curY - 50; y <= curY + 50; y++) { yList.appendChild(createScrollerItem(y, y, y === curY)); }
            openModal(''); setupScrollSnapObserver('monthScroller'); setupScrollSnapObserver('yearScroller');
            setTimeout(() => {
                const activeM = mList.querySelector('.active'); const activeY = yList.querySelector('.active');
                if (activeM) activeM.scrollIntoView({ block: 'center' }); if (activeY) activeY.scrollIntoView({ block: 'center' });
            }, 100);
        }

        function jumpToSelectedMonthYear() {
            const activeM = document.querySelector('#monthScroller .active');
            const activeY = document.querySelector('#yearScroller .active');
            if (activeM && activeY) {
                currentDate.setDate(1); currentDate.setMonth(parseInt(activeM.dataset.value)); currentDate.setFullYear(parseInt(activeY.dataset.value));
                renderCalendar(); updateQuote(); closeModal();
            }
        }

        // Variabel untuk menyimpan argument terakhir showDetail agar bisa refresh modal
        let lastDetailArgs = null;

        // Perhatikan penambahan parameter 'isHardcoded' di posisi terakhir
        function showDetail(d, m, y, dayName, pasaranName, hDate, hMonth, hYear, holiday, cutiName, observanceName, isSunday, birthdayData, anniversaryData, isHardcoded) {
            try {
                const overlay = document.getElementById('selectorModal');
                const body = document.getElementById('modalBody');
                const title = document.getElementById('modalTitle');

                lastDetailArgs = [d, m, y, dayName, pasaranName, hDate, hMonth, hYear, holiday, cutiName, observanceName, isSunday, birthdayData, anniversaryData, isHardcoded];
                console.log("Opening detail for:", d, m, y);

                // --- 1. SETUP ELEMENT DOM ---
                title.classList.add('hidden');
                body.className = "p-4 text-center";

                // --- 2. LOGIKA WARNA & BADGE ---
                const detailQuote = quotes[Math.floor(Math.random() * quotes.length)];

                const isRedDay = isSunday || !!holiday;
                let dateColor = isRedDay ? "text-red-600" : "text-slate-900";
                let subColor = isRedDay ? "text-red-400" : "text-slate-400";
                if (birthdayData) { dateColor = "text-amber-600"; subColor = "text-amber-400"; }
                else if (anniversaryData) { dateColor = "text-pink-600"; subColor = "text-pink-400"; }

                let specialBadge = '';
                if (birthdayData) { const age = y - birthdayData.year; specialBadge += `<div class="mt-2 px-3 py-1 bg-amber-100 text-amber-700 rounded-full font-bold text-[0.65rem] uppercase tracking-wide border border-amber-200 inline-block mx-1 mb-1"> ULTAH ${birthdayData.name} KE-${age}</div>`; }
                if (anniversaryData) { const annAge = y - weddingAnniversary.year; specialBadge += `<div class="mt-2 px-3 py-1 bg-pink-100 text-pink-700 rounded-full font-bold text-[0.65rem] uppercase tracking-wide border border-pink-200 inline-block mx-1 mb-1"> ANNIVERSARY KE-${annAge}</div>`; }
                if (holiday) specialBadge += `<div class="mt-2 px-3 py-1 bg-red-100 text-red-600 rounded-full font-bold text-[0.65rem] uppercase tracking-wide border border-red-200 inline-block mx-1 mb-1">${holiday}</div>`;
                if (cutiName) specialBadge += `<div class="mt-2 px-3 py-1 bg-red-50 text-red-500 rounded-full font-bold text-[0.65rem] uppercase tracking-wide border border-red-200 inline-block mx-1 mb-1">${cutiName}</div>`;
                if (observanceName) specialBadge += `<div class="mt-2 px-3 py-1 bg-blue-50 text-blue-500 rounded-full font-bold text-[0.65rem] uppercase tracking-wide border border-blue-200 inline-block mx-1 mb-1">${observanceName}</div>`;

                // Susun Teks Pasaran & Hijriah
                const pasaranText = settings.showPasaran ? pasaranName : '';
                let hijriTextDisplay = '';
                if (settings.showHijri && hDate) {
                    if (isHardcoded) { hijriTextDisplay = `${hDate} ${hMonth} ${hYear}H`; } else { hijriTextDisplay = `${hDate} ${hMonth}`; }
                }

                // 6. Logika Multi-Note
                const dateKey = `${y}-${m}-${d}`;
                const noteList = getNoteForDate(d, m, y); // Returns Array

                // SORT: Time ascending, no-time at bottom
                noteList.sort((a, b) => {
                    if (a.time && !b.time) return -1; // a has time, b doesn't -> a first
                    if (!a.time && b.time) return 1;  // b has time, a doesn't -> b first
                    if (a.time && b.time) return a.time.localeCompare(b.time); // both have time -> sort ascending
                    return 0; // both don't have time -> keep order
                });

                // --- LOGIKA EVENT PREVIEW (POPUP KECIL) ---
                // Jika tidak ada catatan, tapi ada event (libur/ultah/dll), tampilkan popup preview dulu
                const hasEvents = !!holiday || !!cutiName || !!observanceName || !!birthdayData || !!anniversaryData;
                const hasNotes = noteList.length > 0;

                if (!hasNotes && hasEvents && !showDetail.forceFull) {
                    openModal('pos-center'); // Pastikan nengah
                    // RENDER PREVIEW - POPUP KECIL CENTER
                    body.className = "p-8 text-center";
                    body.innerHTML = `
                        <div class="flex flex-col items-center justify-center mb-6">
                            <div class="text-5xl font-black ${dateColor} leading-none tracking-tighter mb-2">${d}</div>
                            <div class="text-xs font-bold ${subColor} uppercase tracking-widest mb-4">${monthNames[m]} ${y}</div>
                            ${specialBadge ? `<div class="flex flex-col gap-2 items-center mt-2">${specialBadge}</div>` : ''}
                        </div>
                        <div class="mt-6">
                            <button onclick="showDetail.forceFull=true; showDetail(...lastDetailArgs)" class="w-full bg-slate-900 text-white p-3 rounded-2xl font-bold text-xs tracking-wider hover:bg-slate-800 transition shadow-lg">
                                LIHAT DETAIL HARI
                            </button>
                        </div>
                     `;
                    return;
                }
                showDetail.forceFull = false; // Reset flag

                // --- RENDER LIST CATATAN EXISTING ---
                let notesListHTML = '';
                if (noteList.length > 0) {
                    notesListHTML = `<div class="space-y-2 mb-4">`;
                    noteList.forEach((n) => {
                        const isDone = n.isCompleted;

                        // Warna Border & Ikon berdasarkan Kategori
                        let catColor = 'border-slate-200';
                        let catIcon = 'fa-sticky-note';
                        if (n.category === 'kerja') { catColor = 'border-blue-400'; catIcon = 'fa-briefcase text-blue-500'; }
                        else if (n.category === 'penting') { catColor = 'border-red-400'; catIcon = 'fa-exclamation-circle text-red-500'; }
                        else if (n.category === 'ide') { catColor = 'border-amber-400'; catIcon = 'fa-lightbulb text-amber-500'; }
                        else { catColor = 'border-emerald-400'; catIcon = 'fa-sticky-note text-emerald-500'; } // Pribadi

                        notesListHTML += `
                <div class="flex items-start gap-3 p-3 bg-white rounded-xl border-l-4 ${catColor} shadow-sm group">
                    <div class="mt-0.5 cursor-pointer" onclick="toggleStatusAndRender('${dateKey}', '${n.id}', ${d}, ${m}, ${y})">
                        <i class="fas ${isDone ? 'fa-check-circle text-emerald-500' : 'fa-circle text-slate-300'} text-lg"></i>
                    </div>
                    <div class="flex-1 cursor-pointer ${isDone ? 'opacity-50 line-through decoration-slate-400' : ''}" onclick="event.stopPropagation(); openEditNoteModal('${dateKey}', '${n.id}')">
                        <p class="text-sm font-medium text-slate-700 leading-snug pointer-events-none">${n.text}</p>
                        ${n.time ? `<span class="text-[0.65rem] font-bold text-slate-400 bg-slate-100 px-1.5 py-0.5 rounded mt-1 inline-block pointer-events-none"><i class="far fa-clock mr-1"></i>${n.time}</span>` : ''}
                    </div>
                    <button onclick="deleteNoteAndRender('${dateKey}', '${n.id}', ${d}, ${m}, ${y})" class="text-slate-300 hover:text-red-500 transition px-2">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>`;
                    });
                    notesListHTML += `</div>`;
                } else {
                    // USER REQUEST: Tidak perlu menampilkan "Tidak ada catatan" jika kosong
                    notesListHTML = '';
                }

                // 7. Render HTML ke Modal Body
                body.innerHTML = `
            <div class="flex flex-col items-center justify-center mb-6">
                <div class="text-6xl font-black ${dateColor} leading-none tracking-tighter">${d}</div>
                <div class="text-xs font-bold ${subColor} uppercase mt-1 tracking-widest mb-1">${monthNames[m]} ${y}</div>
                ${specialBadge}
            </div>
            
            <div class="bg-white border border-slate-100 rounded-3xl p-4 shadow-sm mb-5">
                <div class="text-xl font-black text-slate-800 uppercase tracking-tight">${dayName} ${pasaranText}</div>
                <div class="text-sm font-medium text-slate-500 mt-1">${hijriTextDisplay}</div>
            </div>
            
            ${noteList.length > 0 ? `<div class="bg-slate-50 border border-slate-100 rounded-3xl p-4 shadow-sm mb-5 text-left">
                <div class="flex justify-between items-center mb-4">
                     <label class="text-xs font-bold text-slate-400 uppercase tracking-widest">Daftar Catatan</label>
                     <span class="text-[0.65rem] font-bold bg-slate-200 text-slate-600 px-2 py-1 rounded-full">${noteList.length} ITEM</span>
                </div>` : '<div class="bg-slate-50 border border-slate-100 rounded-3xl p-4 shadow-sm mb-5 text-left">'}
                
                ${notesListHTML}
                
                <div class="${noteList.length > 0 ? 'border-t border-slate-200 pt-4 mt-2' : ''} text-center">
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Tambah Catatan Baru</label>
                    <div class="flex gap-2 mb-2 justify-center max-w-md mx-auto">
                        <select id="newNoteCategory" onchange="this.style.color = this.options[this.selectedIndex].style.color" class="bg-white border text-xs font-bold uppercase tracking-wider border-slate-200 rounded-lg px-2 py-2 focus:outline-none flex-1" style="color: #94a3b8;">
                            <option value="" disabled selected style="color: #cbd5e1;">KATEGORI</option>
                            <option value="pribadi" style="color: #10b981; font-weight: bold;"> Pribadi</option>
                            <option value="kerja" style="color: #3b82f6; font-weight: bold;"> Kerja</option>
                            <option value="penting" style="color: #ef4444; font-weight: bold;"> Penting</option>
                            <option value="ide" style="color: #f59e0b; font-weight: bold;"> Ide</option>
                        </select>
                        <input type="time" id="newNoteTime" class="bg-white border text-xs font-bold text-slate-600 border-slate-200 rounded-lg px-2 py-2 focus:outline-none flex-1" style="color: #64748b;">
                    </div>
                    <textarea id="noteInput" class="w-full p-3 rounded-xl border border-slate-200 text-sm focus:outline-none focus:border-blue-500 transition h-20 resize-none bg-white mb-2" placeholder="Tulis sesuatu..."></textarea>
                    <button onclick="addNoteAndRender('${dateKey}', ${d}, ${m}, ${y})" class="w-full bg-slate-900 text-white p-3 rounded-xl font-bold text-xs tracking-wider hover:bg-slate-800 transition shadow-lg">
                        <i class="fas fa-plus mr-1"></i> TAMBAH
                    </button>
                </div>
            </div>
            
            <div class="p-5 bg-slate-50 rounded-3xl border border-slate-100 mb-8"> <i class="fas fa-quote-left text-slate-300 text-xl mb-2 block text-center"></i>
                <p class="text-sm italic text-slate-600 leading-relaxed font-medium text-center">"${detailQuote}"</p>
            </div>
            
            <div class="h-4"></div> `;

                openModal('pos-center');
            } catch (err) {
                console.error(err);
                alert("ERR: " + err.message);
            }
        }

        // --- HELPER UNTUK RE-RENDER MODAL SAAT ADA PERUBAHAN ---
        // (Agar user tidak perlu tutup-buka modal setiap kali nambah/hapus)
        function addNoteAndRender(dateKey, d, m, y) {
            const text = document.getElementById('noteInput').value;
            const category = document.getElementById('newNoteCategory').value;
            const time = document.getElementById('newNoteTime').value;

            if (text.trim()) {
                addNote(dateKey, text, category, time);
                // Refresh modal content (tanpa close)
                // Kita panggil showDetail lagi dengan semua parameter (agak hacky, tapi valid untuk single file simple)
                // Tapi kita butuh data-data lain (holiday, pasaran, dll). 
                // SOLUSI: Kita trigger click ulang pada tanggal di kalender? 
                // ATAU: Kita simpan last clicked data?
                // LEBIH BAIK: Kita update hanya bagian list HTML nya? Terlalu ribet manual DOM manipulation.
                // CARA MUDAH: Tutup lalu buka lagi? (Jelek UX)
                // CARA TERBAIK: Panggil ulang handler click elemen tanggal

                // Kita cari elemen tanggal yang sesuai di grid kalender dan klik secara programatik
                // Tapi day-cell tidak punya ID unik.

                // ALTERNATIF: Kita simpan argumen terakhir showDetail di variabel global?
                if (lastDetailArgs) {
                    showDetail(...lastDetailArgs);
                }
            }
        }

        function deleteNoteAndRender(dateKey, id, d, m, y) {
            if (confirm('Hapus catatan ini?')) {
                deleteNote(dateKey, id);
                if (lastDetailArgs) showDetail(...lastDetailArgs);
            }
        }

        function toggleStatusAndRender(dateKey, id, d, m, y) {
            toggleNoteStatus(dateKey, id);
            if (lastDetailArgs) showDetail(...lastDetailArgs);
        }



        let modalClassTimeout = null;

        function openModal(posClassName = '') {
            const overlay = document.getElementById('selectorModal');
            if (modalClassTimeout) { clearTimeout(modalClassTimeout); modalClassTimeout = null; }

            // Reset helper classes first
            overlay.classList.remove('pos-top', 'pos-center');
            // Then apply the requested one
            if (posClassName) overlay.classList.add(posClassName);

            overlay.classList.add('active');
            if (location.hash !== '#modal') {
                history.pushState({ view: 'modal' }, '', '#modal');
            }
        }

        function closeModal(fromHistory = false) {
            const overlay = document.getElementById('selectorModal');
            overlay.classList.remove('active');

            if (!fromHistory && location.hash === '#modal') {
                history.back();
            }

            // Simpan timeout ke variabel agar bisa dibatalkan jika modal dibuka lagi dengan cepat
            modalClassTimeout = setTimeout(() => {
                overlay.classList.remove('pos-top');
                overlay.classList.remove('pos-center');
                modalClassTimeout = null;
            }, 300);
        }

        function setupSwipe() {
            // 1. Swipe untuk Kalender (Ganti Bulan)
            let startX = 0; const area = document.getElementById('swipeArea');
            if (area) {
                area.addEventListener('touchstart', e => { startX = e.changedTouches[0].screenX; }, { passive: true });
                area.addEventListener('touchend', e => {
                    const endX = e.changedTouches[0].screenX; if (endX < startX - 70) changeMonth(1); if (endX > startX + 70) changeMonth(-1);
                }, { passive: true });
            }

            // 2. Swipe untuk Catatanku (Ganti Minggu/Bulan/Tahun)
            const notesArea = document.getElementById('notesViewContainer');
            if (notesArea) {
                let sX = 0;
                notesArea.addEventListener('touchstart', e => { sX = e.changedTouches[0].screenX; }, { passive: true });
                notesArea.addEventListener('touchend', e => {
                    const eX = e.changedTouches[0].screenX;
                    if (eX < sX - 70) navNotes(1);  // Swipe Kiri -> Next
                    if (eX > sX + 70) navNotes(-1); // Swipe Kanan -> Prev
                }, { passive: true });
            }
        }

        // --- 1. INISIALISASI APLIKASI ---
        window.onload = init;

        // --- 2. LOGIKA TOMBOL BACK (UNIVERSAL HANDLER) ---
        // Fungsi ini akan dipanggil oleh Browser Back maupun Tombol Fisik Android
        function handleGlobalBack() {
            const modal = document.getElementById('selectorModal');
            
            // CEK 1: Apakah Modal Terbuka?
            if (modal && modal.classList.contains('active')) {
                // Tutup modal (tanpa mengubah history lagi, karena trigger datang dari back)
                // Kita panggil fungsi close manual tapi set parameter true agar tidak double back
                closeModal(true); 
                return true; // Berhasil handle back
            }

            // CEK 2: Apakah sedang di tampilan Catatanku (Notes)?
            if (typeof isNotesView !== 'undefined' && isNotesView) {
                // Kembali ke Kalender
                toggleNotesView(true);
                return true; // Berhasil handle back
            }

            // CEK 3: Sudah di Home/Calendar?
            return false; // Tidak ada yang di-handle, biarkan sistem yang memproses (Exit)
        }

        // --- 3. HANDLER UNTUK BROWSER / WEBVIEW BIASA ---
        // Menangani navigasi history (misal user swipe back di browser)
        window.onpopstate = function (event) {
            // Kita coba handle logic UI
            const handled = handleGlobalBack();
            
            // Jika logic UI tidak menangkap apa-apa (artinya kita di home),
            // dan user menekan back, browser otomatis akan mundur history.
            // Kita pastikan state konsisten.
            if (!handled) {
                // Jika history habis, biasanya browser diam atau keluar.
                // Kita pastikan kembali ke hash #calendar jika tersesat
                if (location.hash !== '#calendar' && location.hash !== '') {
                    history.replaceState({ view: 'calendar' }, '', '#calendar');
                }
            }
        };

        // --- 4. HANDLER KHUSUS ANDROID (CAPACITOR / HYBRID) ---
        // Kode ini hanya jalan jika aplikasi dibungkus menggunakan Capacitor
        document.addEventListener('DOMContentLoaded', function () {
            if (window.Capacitor) {
                const App = Capacitor.Plugins.App;

                App.addListener('backButton', ({ canGoBack }) => {
                    // Panggil logika manual kita
                    // "Manual Check" karena tombol fisik Android tidak selalu memicu onpopstate
                    const modal = document.getElementById('selectorModal');
                    const isOnNotes = (typeof isNotesView !== 'undefined' && isNotesView);
                    
                    if ((modal && modal.classList.contains('active')) || isOnNotes) {
                        // Jika ada modal atau di notes, kita manipulasi history secara manual
                        // agar sinkron dengan browser history stack
                        history.back(); 
                    } else {
                        // Jika sudah di Halaman Utama (Calendar) & Tidak ada modal
                        App.exitApp();
                    }
                });
            } 
            // OPSIONAL: Jika kamu pakai WebView Android Studio Murni (tanpa Capacitor)
            // Kamu perlu inject JavaScript Interface, tapi biasanya onpopstate di atas sudah cukup
            // jika Android Overridenya benar.
        });
    </script>
</body>

</html>
